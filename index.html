<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interpretación de Espirometría (rápida)</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 100vh;
      overflow: hidden; /* ✅ nunca scroll global */
      background: linear-gradient(135deg,
        rgba(245, 199, 66, 0.95) 0%,
        rgba(245, 199, 66, 0.88) 36%,
        rgba(255, 255, 255, 0.72) 52%,
        rgba(58, 160, 118, 0.88) 68%,
        rgba(58, 160, 118, 0.95) 100%);
      color: #000;
      position: relative;
    }

    body::before{
      content:"";
      position: fixed;
      inset: 0;
      background-image: url("logo-pulmones.png");
      background-repeat: no-repeat;
      background-position: center;
      background-size: min(680px, 70vw);
      opacity: 0.06;
      pointer-events: none;
      z-index: 0;
      filter: saturate(1.15) contrast(1.08);
    }

    .container {
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 10px;
      gap: 8px;
      position: relative;
      z-index: 1;
      overflow: hidden; /* ✅ evita scroll interno */
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.92);
      padding: 8px 16px;
      border-radius: 10px;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.10);
      flex: 0 0 auto;
      min-height: 52px;
      gap: 10px;
    }

    .title-wrap{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
      flex: 1 1 auto;
    }
    .app-logo{
      width: 34px;
      height: 34px;
      border-radius: 9px;
      object-fit: cover;
      border: 2px solid #000;
      background: #fff;
      flex: 0 0 auto;
    }
    h1 {
      font-size: 1.05rem;
      font-weight: 800;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .header-buttons { display: flex; gap: 8px; flex: 0 0 auto; }

    button.icon-btn {
      width: 32px; height: 32px;
      border-radius: 50%;
      border: none;
      background: #000;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
      flex: 0 0 auto;
    }
    button.icon-btn:hover { transform: scale(1.06); }

    /* ✅ grid base (desktop) */
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1.25fr 0.95fr;
      gap: 8px;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    @media (max-width: 1100px){
      .main-grid { grid-template-columns: 1fr 1fr; }
    }

    /* ✅ Mobile: pasamos a “1 pantalla a la vez” (sin scroll) */
    @media (max-width: 720px){
      header { padding: 8px 12px; }
      h1 { font-size: 1.0rem; }

      .main-grid{
        display: block;   /* no grid */
        flex: 1;
        min-height: 0;
        overflow: hidden;
      }
    }

    .card {
      background: rgba(255, 255, 255, 0.92);
      border-radius: 10px;
      padding: 10px;
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      overflow: hidden; /* ✅ clave: nunca scroll en cards */
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      min-height: 0;
    }

    .card h2 {
      font-size: 0.8rem;
      margin-bottom: 6px;
      padding-bottom: 4px;
      border-bottom: 2px solid #000;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      flex: 0 0 auto;
    }

    .input-group { margin-bottom: 6px; flex: 0 0 auto; }
    .input-group label {
      display: block;
      font-size: 0.72rem;
      font-weight: 800;
      margin-bottom: 2px;
    }
    .input-group input, .input-group select {
      width: 100%;
      padding: 6px 7px;
      border: 1px solid #000;
      border-radius: 6px;
      background: #fff;
      font-size: 0.84rem;
      color: #000;
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      flex: 0 0 auto;
    }

    .btn-calc {
      background: #000;
      color: #fff;
      border: none;
      padding: 7px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 900;
      font-size: 0.82rem;
      margin-top: auto;
      flex: 0 0 auto;
    }
    .btn-calc:hover { background: #222; }

    .hint {
      margin-top: 6px;
      font-size: 0.70rem;
      line-height: 1.25;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #9CA3AF;
      background: #F9FAFB;
      color: #374151;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 6;
      -webkit-box-orient: vertical;
      flex: 0 0 auto;
    }

    .tiny {
      font-size: 0.68rem;
      color: #374151;
      line-height: 1.2;
      margin-top: 4px;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
    }

    .quality-warning {
      background: #FEF3C7;
      border: 1px solid #F59E0B;
      color: #92400E;
      padding: 10px;
      border-radius: 8px;
      font-size: 0.73rem;
      margin-top: 8px;
      display: none;
      line-height: 1.25;
      overflow: hidden;
      flex: 0 0 auto;
    }
    .quality-warning.show { display: block; }

    .result-display {
      font-size: 0.8rem;
      line-height: 1.3;
      flex: 0 0 auto;
    }
    .result-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      padding: 2px 0;
      border-bottom: 1px dotted rgba(0,0,0,0.2);
      gap: 10px;
    }
    .result-value { font-weight: 900; text-align: right; white-space: nowrap; }

    .pattern-box {
      background: #000;
      color: #fff;
      padding: 9px;
      border-radius: 8px;
      text-align: center;
      margin-top: 8px;
      font-weight: 900;
      font-size: 0.95rem;
      letter-spacing: 0.2px;
      flex: 0 0 auto;
    }
    .pattern-box.no-interpretable { background: #DC2626; }

    .severity {
      font-size: 0.78rem;
      padding: 7px;
      border-radius: 8px;
      margin-top: 6px;
      text-align: center;
      font-weight: 900;
      flex: 0 0 auto;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .severity.normal { background: #6EE7B7; color: #000; }
    .severity.leve { background: #FDE047; color: #000; }
    .severity.moderado { background: #FB923C; color: #000; }
    .severity.modgrave { background: #FDBA74; color: #000; }
    .severity.severo { background: #F87171; color: #fff; }
    .severity.muy-severo { background: #DC2626; color: #fff; }

    .grade-detail{
      margin-top: 8px;
      padding: 8px;
      border-radius: 10px;
      border: 1px dashed #000;
      background: rgba(255,255,255,0.85);
      font-size: 0.72rem;
      line-height: 1.28;
      color: #111827;
      display: none;
      white-space: pre-wrap;
      overflow: hidden;
      flex: 0 0 auto;
    }
    .grade-detail.show{ display:block; }
    .grade-detail .k { font-weight: 900; }
    .grade-chip{
      display:inline-block;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid #000;
      background:#fff;
      font-weight:900;
      font-size: 0.7rem;
      margin-left: 6px;
    }

    .plan-section{
      margin-top: 10px;
      padding-top: 10px;
      border-top: 2px solid #000;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
      overflow: hidden;
      flex: 1 1 auto;
    }
    .plan-title{
      font-size: 0.75rem;
      font-weight: 900;
      letter-spacing: 0.2px;
      text-transform: uppercase;
      flex: 0 0 auto;
    }
    .plan-note{
      font-size: 0.7rem;
      color: #374151;
      line-height: 1.25;
      flex: 0 0 auto;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .plan-box{
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 10px;
      font-size: 0.74rem;
      color: #111827;
      line-height: 1.28;
      overflow: hidden;
      min-height: 0;
      white-space: pre-wrap;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 12;
      flex: 1 1 auto;
    }

    #flowVolumeChart {
      width: 100%;
      height: 130px;
      background: #fff;
      border-radius: 8px;
      border: 1px solid #000;
      flex: 0 0 auto;
    }

    .chart-legend {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 6px;
      font-size: 0.65rem;
      flex: 0 0 auto;
      overflow: hidden;
    }
    .legend-item { display: flex; align-items: center; gap: 3px; }
    .legend-line { width: 12px; height: 2px; border-radius: 2px; }

    .bd-section {
      border-top: 1px dashed #000;
      margin-top: 8px;
      padding-top: 8px;
      overflow: hidden;
      flex: 1 1 auto;
      min-height: 0;
    }
    .bd-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      font-weight: 900;
      font-size: 0.78rem;
      margin-bottom: 6px;
      flex: 0 0 auto;
    }
    .bd-content { display: none; overflow: hidden; }
    .bd-content.open { display: block; }

    .bd-result {
      background: #000;
      color: #fff;
      padding: 7px;
      border-radius: 8px;
      text-align: center;
      margin-top: 8px;
      font-size: 0.8rem;
      font-weight: 900;
      flex: 0 0 auto;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* ✅ flujo (desktop) */
    .algorithm-flow {
      background: rgba(255, 255, 255, 0.92);
      border-radius: 10px;
      padding: 8px 12px;
      backdrop-filter: blur(10px);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      font-size: 0.7rem;
      flex-wrap: wrap;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow: hidden;
      flex: 0 0 auto;
    }
    .flow-step {
      padding: 5px 8px;
      border-radius: 15px;
      background: #e5e7eb;
      border: 2px solid transparent;
      font-weight: 900;
      transition: all 0.25s;
      white-space: nowrap;
    }
    .flow-step.active {
      background: #000;
      color: #fff;
      border-color: #000;
      transform: scale(1.04);
    }
    .flow-step.completed {
      background: #6EE7B7;
      border-color: #000;
    }
    .flow-step.error {
      background: #DC2626;
      color: #fff;
      border-color: #DC2626;
    }
    .arrow { font-size: 0.9rem; color: #000; }

    /* ✅ flujo (mobile): una sola línea */
    @media (max-width: 720px){
      .algorithm-flow{
        flex-wrap: nowrap;
        justify-content: space-between;
        gap: 6px;
        padding: 6px 8px;
        font-size: 0.62rem;
      }
      .arrow{ display:none; }
      .flow-step{
        padding: 4px 6px;
        border-radius: 999px;
        font-weight: 900;
        max-width: 16.5%;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .flow-step::after{
        content:"";
      }
    }

    footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.92);
      padding: 8px 16px;
      border-radius: 10px;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      flex: 0 0 auto;
      overflow: hidden;
      min-height: 52px;
      gap: 10px;
    }
    .btn-generate {
      background: #000;
      color: #fff;
      border: none;
      padding: 8px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 900;
      font-size: 0.86rem;
      flex: 0 0 auto;
    }
    .credit {
      font-size: 0.7rem;
      font-weight: 600;
      color: #000;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      min-width: 0;
      flex: 1 1 auto;
      text-align: right;
    }

    /* ✅ MODALES: los ÚNICOS con scroll permitido */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      max-width: 920px;
      width: 92%;
      max-height: 85vh;
      overflow-y: auto; /* ✅ permitido (ℹ, resumen, ATS) */
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 14px;
      font-size: 22px;
      cursor: pointer;
      background: none;
      border: none;
    }
    .modal h3 { margin-bottom: 12px; font-size: 1.1rem; }

    .report-text {
      background: #f3f4f6;
      padding: 14px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 0.75rem;
      white-space: pre-wrap;
      margin-top: 12px;
      border: 1px solid #000;
    }
    .copy-btn {
      background: #000;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
      font-weight: 900;
    }

    .tabs {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin: 8px 0 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e5e7eb;
    }
    .tab-btn {
      appearance: none;
      border: 1px solid #000;
      background: #fff;
      color: #000;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.78rem;
      font-weight: 900;
      cursor: pointer;
      transition: transform 0.12s;
      line-height: 1;
    }
    .tab-btn:hover { transform: scale(1.02); }
    .tab-btn.active { background: #000; color: #fff; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 720px){
      .info-grid { grid-template-columns: 1fr; }
    }

    .info-card {
      background: #f9fafb;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
    }
    .info-card h4 { font-size: 0.82rem; margin-bottom: 4px; color: #000; }
    .info-card p, .info-card ul { font-size: 0.75rem; color: #374151; line-height: 1.35; }
    .info-card ul{ margin-left: 16px; }

    input:invalid{
      outline: 2px solid #DC2626;
      border-color: #DC2626;
    }
    .field-error{
      margin-top: 8px;
      font-size: 0.72rem;
      line-height: 1.25;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #DC2626;
      background: rgba(220,38,38,0.08);
      color: #7F1D1D;
      display: none;
      white-space: pre-wrap;
      overflow: hidden;
      flex: 0 0 auto;
    }
    .field-error.show{ display:block; }

    /* ✅ Botón pequeño inline */
    .mini-btn{
      border: 1px solid #000;
      background: #fff;
      color: #000;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 0.75rem;
      cursor: pointer;
      line-height: 1;
      white-space: nowrap;
    }
    .mini-btn.primary{
      background: #000;
      color: #fff;
    }

    .row-between{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 8px;
    }
    .badge{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #000;
      background: #fff;
      font-weight: 900;
      font-size: 0.70rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    .badge.warn{ border-color:#DC2626; color:#7F1D1D; background: rgba(220,38,38,0.06); }

    /* ✅ Mobile tabs (parámetros/calidad/interp/pbd) */
    .mobile-nav{
      display:none;
      background: rgba(255,255,255,0.92);
      border-radius: 10px;
      padding: 6px;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      gap: 6px;
      flex: 0 0 auto;
      overflow: hidden;
    }
    .mnav-btn{
      flex: 1 1 0;
      border: 1px solid #000;
      background: #fff;
      color: #000;
      border-radius: 999px;
      padding: 7px 8px;
      font-weight: 900;
      font-size: 0.72rem;
      cursor: pointer;
      line-height: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .mnav-btn.active{
      background:#000;
      color:#fff;
    }

    /* Mobile behavior */
    @media (max-width: 720px){
      .mobile-nav{ display:flex; }
      /* solo se ve una “card panel” */
      .card[data-panel]{ display:none; }
      .card[data-panel].active{ display:flex; }
      /* curva fuera en móvil */
      #flowVolumeChart, .chart-legend{ display:none !important; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="title-wrap">
        <img class="app-logo" src="logo-pulmones.png" alt="Logo pulmones">
        <h1>Interpretación de Espirometría (rápida)</h1>
      </div>
      <div class="header-buttons">
        <button class="icon-btn" onclick="openInfoModal()" title="Información">ℹ</button>
        <button class="icon-btn" onclick="clearAll()" title="Limpiar todo">L</button>
      </div>
    </header>

    <!-- ✅ Mobile nav: una pantalla a la vez (sin scroll) -->
    <div class="mobile-nav" aria-label="Navegación móvil">
      <button class="mnav-btn active" id="mnavParams" onclick="setMobilePanel('params')">Parámetros</button>
      <button class="mnav-btn" id="mnavQuality" onclick="setMobilePanel('quality')">Calidad</button>
      <button class="mnav-btn" id="mnavInterp" onclick="setMobilePanel('interp')">Interpretación</button>
      <button class="mnav-btn" id="mnavPbd" onclick="setMobilePanel('pbd')">PBD</button>
    </div>

    <div class="main-grid">
      <!-- PARÁMETROS (PRE) -->
      <div class="card active" data-panel="params" id="panelParams">
        <h2>Parámetros (PRE)</h2>

        <div class="input-row">
          <div class="input-group">
            <label>Mejor FVC (l)</label>
            <input type="number" id="mejorFVC" step="0.01" min="0.20" max="8.00" inputmode="decimal" placeholder="Ej: 4.85" oninput="calcularTodo()">
          </div>
          <div class="input-group">
            <label>Mejor FEV1 (l)</label>
            <input type="number" id="mejorFEV1" step="0.01" min="0.20" max="8.00" inputmode="decimal" placeholder="Ej: 3.11" oninput="calcularTodo()">
          </div>
        </div>

        <div class="input-group">
          <label>MFEV1/MFVC (%)</label>
          <input type="number" id="ratioMF" step="0.01" min="20" max="110" inputmode="decimal" placeholder="Del informe" oninput="calcularTodo()">
          <div class="tiny">Tip: si metes Mejor FEV1 y Mejor FVC, te lo calcula y lo rellena si está vacío (y no lo pisa si lo escribes tú).</div>
        </div>

        <div class="input-row">
          <div class="input-group">
            <label>FVC %REF</label>
            <input type="number" id="fvcRef" step="0.1" min="10" max="250" inputmode="decimal" placeholder="Ej: 150" oninput="calcularTodo()">
          </div>
          <div class="input-group">
            <label>FEV1 %REF</label>
            <input type="number" id="fev1Ref" step="0.1" min="10" max="250" inputmode="decimal" placeholder="Ej: 125" oninput="calcularTodo()">
          </div>
        </div>

        <div class="input-group">
          <label>FEF25%-75% %REF (opcional)</label>
          <input type="number" id="fefRef" step="0.1" min="10" max="250" inputmode="decimal" placeholder="Ej: 81" oninput="calcularTodo()">
        </div>

        <div class="field-error" id="fieldError"></div>

        <div class="hint">
          Para cerrar patrón rápido, normalmente basta con:
          <br>• <strong>MFEV1/MFVC (%)</strong> (corte fijo 70)
          <br>• <strong>FVC %REF</strong> (80)
          <br>El <strong>grado</strong> (si hay obstrucción) se apoya en <strong>FEV1 %REF</strong>.
        </div>

        <button class="btn-calc" onclick="calcularTodo()">Calcular</button>
      </div>

      <!-- CALIDAD -->
      <div class="card" data-panel="quality" id="panelQuality">
        <h2>Calidad</h2>

        <div class="input-group">
          <label>Calidad suficiente (según tú / según informe)</label>
          <select id="manualQuality" onchange="calcularTodo()">
            <option value="">— (usar ATS/ERS)</option>
            <option value="si">Sí (interpretable)</option>
            <option value="no">No (no interpretable)</option>
          </select>
          <div class="tiny">
            Si seleccionas “Sí” o “No”, no hace falta rellenar ATS/ERS.
            Si dejas “—”, rellena ATS/ERS (en el botón de abajo).
          </div>
        </div>

        <div class="row-between" style="margin-top:6px;">
          <button class="mini-btn primary" onclick="openATSModal()">ATS/ERS</button>
          <span class="badge" id="atsSummary">ATS/ERS: —</span>
        </div>

        <div class="hint">
          Regla operativa (seguridad):
          <br>• <strong>NO interpretable</strong> si calidad “F” o repetibilidad “No” en FVC o FEV1.
          <br>• Si faltan datos ATS/ERS → “pendiente” (la app NO interpreta).
        </div>

        <div class="quality-warning" id="qualityWarning">
          <strong>NO INTERPRETABLE.</strong>
          <br>Evita decisiones basadas en esta prueba. Repetir asegurando calidad y repetibilidad.
        </div>

        <button class="btn-calc" onclick="calcularTodo()">Calcular</button>
      </div>

      <!-- INTERPRETACIÓN + PLAN -->
      <div class="card" data-panel="interp" id="panelInterp">
        <h2>Interpretación</h2>

        <div class="result-display">
          <div class="result-item">
            <span>INTERPRETABLE</span>
            <span class="result-value" id="outInterpretable">—</span>
          </div>
          <div class="result-item">
            <span>Obstrucción (ratio &lt; 70)</span>
            <span class="result-value" id="outObstruccion">—</span>
          </div>
          <div class="result-item">
            <span>MFEV1/MFVC (%)</span>
            <span class="result-value" id="outRatio">—</span>
          </div>
          <div class="result-item">
            <span>FVC %REF</span>
            <span class="result-value" id="outFvcRef">—</span>
          </div>
          <div class="result-item">
            <span>FEV1 %REF</span>
            <span class="result-value" id="outFev1Ref">—</span>
          </div>
          <div class="result-item">
            <span>FEF25%-75% %REF (opc)</span>
            <span class="result-value" id="outFefRef">—</span>
          </div>
        </div>

        <div class="pattern-box" id="patron">PENDIENTE</div>
        <div class="severity" id="severidad"></div>
        <div class="grade-detail" id="gradoDetalle"></div>

        <div class="plan-section">
          <div class="plan-title">Orientación y manejo</div>
          <div class="plan-note">Devuelve patrón funcional + próximos pasos. La clínica manda.</div>

          <div class="input-row">
            <div class="input-group">
              <label>Sospecha clínica</label>
              <select id="sospecha" onchange="updatePlan()">
                <option value="no">No especificada</option>
                <option value="epoc">EPOC</option>
                <option value="asma">Asma</option>
                <option value="otros">Otros</option>
              </select>
            </div>
            <div class="input-group">
              <label>Contexto</label>
              <select id="contexto" onchange="updatePlan()">
                <option value="ap">Atención Primaria</option>
                <option value="seguimiento">Seguimiento</option>
                <option value="diagnostico">Duda diagnóstica</option>
              </select>
            </div>
          </div>

          <div class="plan-box" id="planBox">Introduce valores, añade calidad y calcula.</div>
        </div>
      </div>

      <!-- PBD (en desktop: curva+pbd; en móvil: solo PBD porque la curva se oculta por CSS) -->
      <div class="card" data-panel="pbd" id="panelPbd">
        <h2>Curva y PBD</h2>

        <canvas id="flowVolumeChart"></canvas>
        <div class="chart-legend">
          <div class="legend-item">
            <div class="legend-line" style="background:#000;"></div>
            <span>PRE (esquemático)</span>
          </div>
          <div class="legend-item">
            <div class="legend-line" style="background:#9CA3AF; height:1px; border-top:1px dashed #9CA3AF;"></div>
            <span>Ref (esquemático)</span>
          </div>
        </div>

        <div class="bd-section">
          <div class="bd-header" onclick="toggleBD()">
            <span>Prueba Broncodilatadora</span>
            <span id="bdArrow">▼</span>
          </div>

          <div class="bd-content" id="bdContent">
            <div class="input-group">
              <label>Mejor FEV1 (l) PRE</label>
              <input type="number" id="bdFev1Pre" step="0.01" readonly>
            </div>

            <div class="input-group">
              <label>Mejor FEV1 (l) POST</label>
              <input type="number" id="bdFev1Post" step="0.01" min="0.20" max="8.00" inputmode="decimal" placeholder="Del informe post" oninput="calcularBD()">
            </div>

            <div class="bd-result" id="bdresult">No calculada</div>

            <div class="hint" style="margin-top:10px;">
              Criterio implementado (clásico): <strong>positiva</strong> si ΔFEV1 ≥200 ml y ≥12% respecto a PRE.
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="algorithm-flow" aria-label="Progreso">
      <div class="flow-step" id="step1">CALIDAD</div>
      <span class="arrow">→</span>
      <div class="flow-step" id="step2">REPET</div>
      <span class="arrow">→</span>
      <div class="flow-step" id="step3">RATIO&lt;0,70</div>
      <span class="arrow">→</span>
      <div class="flow-step" id="step4">FVC≤80</div>
      <span class="arrow">→</span>
      <div class="flow-step" id="step5">PATRÓN</div>
      <span class="arrow">→</span>
      <div class="flow-step" id="step6">GRADO</div>
    </div>

    <footer>
      <button class="btn-generate" onclick="generarInforme()">Generar Informe</button>
      <span class="credit">Hecho por Guillermo J. Olivero Sanjuanelo</span>
    </footer>
  </div>

  <!-- MODAL INFORME -->
  <div class="modal-overlay" id="reportModal">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('reportModal')">X</button>
      <h3>Informe (resumen)</h3>
      <pre class="report-text" id="reportContent"></pre>
      <button class="copy-btn" onclick="copiarInforme()">Copiar</button>
    </div>
  </div>

  <!-- MODAL ATS/ERS (para que NO se corte y solo haya scroll aquí) -->
  <div class="modal-overlay" id="atsModal">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('atsModal')">X</button>
      <h3>ATS/ERS (PRE) · Calidad y repetibilidad</h3>

      <div class="info-card" style="margin-bottom:10px;">
        <p>
          Esta sección solo se usa si en “Calidad suficiente” has dejado “— (usar ATS/ERS)”.
          Si falta algún campo, la app deja <strong>INTERPRETABLE = —</strong> (pendiente).
        </p>
      </div>

      <div class="info-grid">
        <div class="info-card">
          <h4>Grado ATS/ERS (PRE)</h4>
          <div class="input-row">
            <div class="input-group">
              <label>FVC</label>
              <select id="calidadFVC" onchange="calcularTodo(); updateATSSummary();">
                <option value="">—</option>
                <option value="A">A</option><option value="B">B</option><option value="C">C</option>
                <option value="D">D</option><option value="E">E</option><option value="F">F</option>
              </select>
            </div>
            <div class="input-group">
              <label>FEV1</label>
              <select id="calidadFEV1" onchange="calcularTodo(); updateATSSummary();">
                <option value="">—</option>
                <option value="A">A</option><option value="B">B</option><option value="C">C</option>
                <option value="D">D</option><option value="E">E</option><option value="F">F</option>
              </select>
            </div>
          </div>
        </div>

        <div class="info-card">
          <h4>Repetibilidad ATS/ERS (PRE)</h4>
          <div class="input-row">
            <div class="input-group">
              <label>FVC</label>
              <select id="repFVC" onchange="calcularTodo(); updateATSSummary();">
                <option value="">—</option>
                <option value="si">Sí</option>
                <option value="no">No</option>
              </select>
            </div>
            <div class="input-group">
              <label>FEV1</label>
              <select id="repFEV1" onchange="calcularTodo(); updateATSSummary();">
                <option value="">—</option>
                <option value="si">Sí</option>
                <option value="no">No</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="info-card" style="margin-top:10px;">
        <p>
          Regla (seguridad): si calidad “F” <strong>o</strong> repetibilidad “No” en FVC o FEV1 → <strong>NO interpretable</strong>.
        </p>
      </div>

      <button class="copy-btn" onclick="closeModal('atsModal')">Listo</button>
    </div>
  </div>

  <!-- MODAL INFO ℹ -->
  <div class="modal-overlay" id="infoModal">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('infoModal')">X</button>
      <h3>Información útil (para no perder tiempo)</h3>

      <div class="tabs" role="tablist" aria-label="Pestañas de información">
        <button class="tab-btn" id="tabBtnUse" type="button" onclick="openInfoTab('tabUse')">Uso</button>
        <button class="tab-btn" id="tabBtnQual" type="button" onclick="openInfoTab('tabQual')">Calidad</button>
        <button class="tab-btn" id="tabBtnInterp" type="button" onclick="openInfoTab('tabInterp')">Interpretación</button>
        <button class="tab-btn" id="tabBtnAsthma" type="button" onclick="openInfoTab('tabAsthma')">Asma</button>
        <button class="tab-btn" id="tabBtnCopd" type="button" onclick="openInfoTab('tabCopd')">EPOC</button>
        <button class="tab-btn" id="tabBtnOther" type="button" onclick="openInfoTab('tabOther')">Otros</button>
      </div>

      <div class="tab-panel" id="tabUse">
        <div class="info-grid">
          <div class="info-card">
            <h4>Cómo usar en 30–60 s</h4>
            <p>
              1) Copia del informe: <strong>MFEV1/MFVC (%)</strong>, <strong>FVC %REF</strong> y (si hay obstrucción) <strong>FEV1 %REF</strong>.<br>
              2) En “Calidad suficiente” marca si es interpretable (si el informe lo deja claro).<br>
              3) Pulsa “Calcular”. Si hay broncodilatadora, añade POST y se calcula sola.
            </p>
          </div>
          <div class="info-card">
            <h4>Qué devuelve</h4>
            <p>
              • <strong>Interpretable</strong> (manual o ATS/ERS).<br>
              • <strong>Patrón</strong>: normal / obstructivo (puro o mixto) / restrictivo sugerido.<br>
              • <strong>Grado</strong> de obstrucción (si hay FEV1 %REF).<br>
              • “Plan” orientativo (no sustituye juicio clínico).
            </p>
          </div>
        </div>
      </div>

      <div class="tab-panel" id="tabQual">
        <div class="info-grid">
          <div class="info-card">
            <h4>Opción rápida: “Calidad suficiente”</h4>
            <p>
              Úsala si el informe ya te deja claro que es válida/repetible o tú lo has visto.<br>
              • “Sí” → la app interpreta.<br>
              • “No” → la app corta y recomienda repetir.
            </p>
          </div>
          <div class="info-card">
            <h4>Si usas ATS/ERS</h4>
            <p>
              Regla práctica:<br>
              • Si calidad “F” o repetibilidad “No” → <strong>NO interpretable</strong>.<br>
              • Si faltan datos → <strong>pendiente</strong>.
            </p>
          </div>
        </div>
      </div>

      <div class="tab-panel" id="tabInterp">
        <div class="info-grid">
          <div class="info-card">
            <h4>Obstrucción (corte fijo)</h4>
            <p>
              En esta app: <strong>obstrucción si MFEV1/MFVC (%) &lt; 70</strong>.
            </p>
          </div>
          <div class="info-card">
            <h4>Restricción sugerida</h4>
            <p>
              Si NO hay obstrucción y <strong>FVC %REF ≤80</strong> → <strong>restrictivo sugerido</strong>.
            </p>
          </div>
          <div class="info-card">
            <h4>Mixto vs atrapamiento</h4>
            <p>
              Si hay obstrucción y <strong>FVC %REF ≤80</strong> → “mixto” (restricción o atrapamiento).
            </p>
          </div>
          <div class="info-card">
            <h4>Normal</h4>
            <p>
              Sin obstrucción y FVC %REF &gt;80 → normal. Normal no excluye asma intercrisis.
            </p>
          </div>
        </div>
      </div>

      <div class="tab-panel" id="tabAsthma">
        <div class="info-grid">
          <div class="info-card">
            <h4>Asma: qué buscar</h4>
            <p>
              Variabilidad + clínica compatible. Espirometría normal no excluye asma intercrisis.
            </p>
          </div>
          <div class="info-card">
            <h4>Broncodilatadora</h4>
            <p>
              PBD positiva apoya variabilidad. PBD negativa no excluye asma.
            </p>
          </div>
        </div>
      </div>

      <div class="tab-panel" id="tabCopd">
        <div class="info-grid">
          <div class="info-card">
            <h4>EPOC: diagnóstico práctico</h4>
            <p>
              Obstrucción persistente + exposición + síntomas crónicos. PBD positiva NO descarta EPOC.
            </p>
          </div>
          <div class="info-card">
            <h4>Qué registrar</h4>
            <p>
              Exacerbaciones, síntomas, tabaco, vacunación, técnica/adherencia, ejercicio/rehab.
            </p>
          </div>
        </div>
      </div>

      <div class="tab-panel" id="tabOther">
        <div class="info-grid">
          <div class="info-card">
            <h4>Otros usos en AP</h4>
            <p>
              Disnea crónica, seguimiento, sospecha restrictiva (confirmar si cambia conducta).
            </p>
          </div>
          <div class="info-card">
            <h4>Regla mental</h4>
            <p>
              1) ¿Interpretable? 2) ¿Obstrucción? 3) ¿FVC baja? 4) Clínica manda.
            </p>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    let current = {
      fecha: new Date().toLocaleDateString('es-ES'),
      patron: null,
      severidad: null,
      severidadClass: '',
      obstruccion: null,
      interpretable: null,
      bd: null
    };

    let hasEverCalculated = false;

    function num(id){
      const el = document.getElementById(id);
      if (!el) return null;
      const v = parseFloat(el.value);
      return isNaN(v) ? null : v;
    }
    function txt(id){
      const el = document.getElementById(id);
      if (!el) return '';
      return (el.value || '').trim();
    }

    // ✅ Mobile panels
    function setMobilePanel(panel){
      const map = {
        params: 'panelParams',
        quality:'panelQuality',
        interp: 'panelInterp',
        pbd:   'panelPbd'
      };
      Object.values(map).forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.classList.remove('active');
      });
      const target = document.getElementById(map[panel]);
      if (target) target.classList.add('active');

      ['mnavParams','mnavQuality','mnavInterp','mnavPbd'].forEach(id=>{
        const b = document.getElementById(id);
        if (b) b.classList.remove('active');
      });
      const btn = document.getElementById(panel==='params'?'mnavParams':panel==='quality'?'mnavQuality':panel==='interp'?'mnavInterp':'mnavPbd');
      if (btn) btn.classList.add('active');
    }

    function setFieldError(msg){
      const box = document.getElementById('fieldError');
      if (!box) return;
      if (!msg) { box.textContent=''; box.classList.remove('show'); return; }
      box.textContent = msg;
      box.classList.add('show');
    }
    function inRange(v, min, max){
      return v !== null && v >= min && v <= max;
    }
    function validateHumanLimits(){
      const fvc = num('mejorFVC');
      const fev1 = num('mejorFEV1');
      const ratio = num('ratioMF');
      const fvcRef = num('fvcRef');
      const fev1Ref = num('fev1Ref');
      const fefRef = num('fefRef');
      const post = num('bdFev1Post');

      if (fvc !== null && !inRange(fvc, 0.20, 8.00)) return 'Mejor FVC fuera de rango (0.20–8.00 L).';
      if (fev1 !== null && !inRange(fev1, 0.20, 8.00)) return 'Mejor FEV1 fuera de rango (0.20–8.00 L).';
      if (ratio !== null && !inRange(ratio, 20, 110)) return 'MFEV1/MFVC fuera de rango (20–110%).';
      if (fvcRef !== null && !inRange(fvcRef, 10, 250)) return 'FVC %REF fuera de rango (10–250%).';
      if (fev1Ref !== null && !inRange(fev1Ref, 10, 250)) return 'FEV1 %REF fuera de rango (10–250%).';
      if (fefRef !== null && !inRange(fefRef, 10, 250)) return 'FEF25–75 %REF fuera de rango (10–250%).';
      if (post !== null && !inRange(post, 0.20, 8.00)) return 'PBD POST (FEV1) fuera de rango (0.20–8.00 L).';

      return null;
    }

    function isGradeAcceptable(g){
      if (!g) return null;
      if (g === 'F') return false;
      return true;
    }
    function isRepOK(r){
      if (!r) return null;
      return r === 'si';
    }

    function setStep(el, state){
      el.classList.remove('active','completed','error');
      if (state) el.classList.add(state);
    }

    function resetSteps(){
      ['step1','step2','step3','step4','step5','step6'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.classList.remove('active','completed','error');
      });
    }

    function autoFillRatioIfEmpty(){
      const fvc = num('mejorFVC');
      const fev1 = num('mejorFEV1');
      const ratioInput = document.getElementById('ratioMF');
      if (!ratioInput) return;
      const raw = (ratioInput.value || '').trim();
      if (raw !== '') return;
      if (fvc && fev1 && fvc > 0) {
        ratioInput.value = ((fev1 / fvc) * 100).toFixed(2);
      }
    }

    function getObstructionGradeFromRef(fev1Ref){
      if (fev1Ref === null || fev1Ref === undefined || isNaN(fev1Ref)) return null;
      if (fev1Ref > 70) return { label: 'Leve', cls: 'leve' };
      if (fev1Ref >= 60) return { label: 'Moderada', cls: 'moderado' };
      if (fev1Ref >= 50) return { label: 'Moderadamente grave', cls: 'modgrave' };
      if (fev1Ref >= 35) return { label: 'Grave', cls: 'severo' };
      return { label: 'Muy grave', cls: 'muy-severo' };
    }

    function renderGradeDetail(data){
      const box = document.getElementById('gradoDetalle');
      if (!box) return;
      if (!data || !data.show) {
        box.classList.remove('show');
        box.textContent = '';
        return;
      }
      const chip = `<span class="grade-chip">${data.chip}</span>`;
      box.innerHTML =
        `<span class="k">Detalle</span>${chip}\n` +
        `${data.mainLine}\n` +
        `${data.subLine ? data.subLine + '\n' : ''}` +
        `${data.note ? data.note : ''}`;
      box.classList.add('show');
    }

    function updateOutputs(){
      document.getElementById('outInterpretable').textContent =
        (current.interpretable === null) ? '—' : (current.interpretable ? 'SÍ' : 'NO');
      document.getElementById('outObstruccion').textContent =
        (current.obstruccion === null) ? '—' : (current.obstruccion ? 'SÍ' : 'NO');

      const r = num('ratioMF');
      const fvcRef = num('fvcRef');
      const fev1Ref = num('fev1Ref');
      const fefRef = num('fefRef');

      document.getElementById('outRatio').textContent = (r===null) ? '—' : (r.toFixed(2) + '%');
      document.getElementById('outFvcRef').textContent = (fvcRef===null) ? '—' : (fvcRef.toFixed(1) + '%');
      document.getElementById('outFev1Ref').textContent = (fev1Ref===null) ? '—' : (fev1Ref.toFixed(1) + '%');
      document.getElementById('outFefRef').textContent = (fefRef===null) ? '—' : (fefRef.toFixed(1) + '%');

      const pre = num('mejorFEV1');
      const preEl = document.getElementById('bdFev1Pre');
      if (preEl) preEl.value = (pre===null) ? '' : pre.toFixed(2);
    }

    function updateATSSummary(){
      const q1 = txt('calidadFVC') || '—';
      const q2 = txt('calidadFEV1') || '—';
      const r1 = txt('repFVC') || '—';
      const r2 = txt('repFEV1') || '—';
      const manual = txt('manualQuality');

      const badge = document.getElementById('atsSummary');
      if (!badge) return;

      if (manual === 'si') { badge.textContent = 'ATS/ERS: no usado (manual: Sí)'; badge.className='badge'; return; }
      if (manual === 'no') { badge.textContent = 'ATS/ERS: no usado (manual: No)'; badge.className='badge'; return; }

      const incomplete = (q1==='—' || q2==='—' || r1==='—' || r2==='—');
      badge.textContent = `ATS/ERS: FVC ${q1}/${r1} · FEV1 ${q2}/${r2}`;
      badge.className = incomplete ? 'badge warn' : 'badge';
    }

    function computeInterpretability(){
      const manual = txt('manualQuality');
      if (manual === 'si') return true;
      if (manual === 'no') return false;

      const qFVC = isGradeAcceptable(txt('calidadFVC'));
      const qFEV1 = isGradeAcceptable(txt('calidadFEV1'));
      const rFVC = isRepOK(txt('repFVC'));
      const rFEV1 = isRepOK(txt('repFEV1'));

      if (qFVC === null || qFEV1 === null || rFVC === null || rFEV1 === null) return null;
      return (qFVC && qFEV1 && rFVC && rFEV1);
    }

    function calcularPatronYGrado(){
      resetSteps();

      const step1 = document.getElementById('step1');
      const step2 = document.getElementById('step2');
      const step3 = document.getElementById('step3');
      const step4 = document.getElementById('step4');
      const step5 = document.getElementById('step5');
      const step6 = document.getElementById('step6');

      const limitsError = validateHumanLimits();
      if (limitsError) {
        setFieldError(limitsError);
        current.interpretable = null;
        current.obstruccion = null;
        current.patron = 'PENDIENTE (revisar valores)';
        current.severidad = '';
        current.severidadClass = '';
        renderGradeDetail({
          show:true,
          chip:'Valores',
          mainLine:'• Corrige el valor fuera de rango.',
          subLine:limitsError,
          note:''
        });
        showResult();
        updatePlan();
        drawChart();
        return;
      }
      setFieldError(null);

      current.interpretable = computeInterpretability();

      if (current.interpretable === null) {
        setStep(step1,'active'); setStep(step2,'active');
      } else if (current.interpretable === true) {
        setStep(step1,'completed'); setStep(step2,'completed');
      } else {
        setStep(step1,'error'); setStep(step2,'error');
      }

      const warn = document.getElementById('qualityWarning');
      if (warn){
        if (current.interpretable === false && hasEverCalculated) warn.classList.add('show');
        else warn.classList.remove('show');
      }

      if (current.interpretable === null) {
        current.patron = 'PENDIENTE (calidad no confirmada)';
        current.severidad = '';
        current.severidadClass = '';
        current.obstruccion = null;
        renderGradeDetail({
          show:true,
          chip:'Calidad',
          mainLine:'• No se interpreta hasta confirmar calidad.',
          subLine:'• Marca “Calidad suficiente: Sí/No” o completa ATS/ERS (FVC+FEV1 + repetibilidad).',
          note:''
        });
        showResult();
        updatePlan();
        drawChart();
        return;
      }

      if (current.interpretable === false) {
        current.patron = 'NO INTERPRETABLE';
        current.severidad = 'Repetir (calidad/repetibilidad insuficiente)';
        current.severidadClass = '';
        current.obstruccion = null;
        showResultNoInterpretable();
        return;
      }

      const ratio = num('ratioMF');
      const fvcRef = num('fvcRef');
      const fev1Ref = num('fev1Ref');

      if (ratio === null) {
        current.obstruccion = null;
        current.patron = 'PENDIENTE (falta RATIO)';
        current.severidad = '';
        current.severidadClass = '';
        setStep(step3,'active'); setStep(step5,'active'); setStep(step6,'active');
        renderGradeDetail({
          show:true,
          chip:'Faltan datos',
          mainLine:'• Para decidir obstrucción: introduce MFEV1/MFVC (%).',
          subLine:'',
          note:''
        });
        updatePlan();
        drawChart();
        showResult();
        return;
      }

      current.obstruccion = (ratio < 70);
      setStep(step3,'completed'); setStep(step3,'active');

      const hasFvcRef = (fvcRef !== null);

      let patron = 'PENDIENTE';
      let sev = '';
      let sevClass = '';
      let detail = { show:false };

      if (current.obstruccion) {
        if (hasFvcRef) {
          patron = (fvcRef <= 80) ? 'OBSTRUCTIVO MIXTO' : 'OBSTRUCTIVO PURO';
          setStep(step4,'completed');
          if (fvcRef <= 80) setStep(step4,'active');
        } else {
          patron = 'OBSTRUCTIVO (falta FVC %REF para puro/mixto)';
          setStep(step4,'active');
        }
        setStep(step5,'completed'); setStep(step5,'active');

        const g = getObstructionGradeFromRef(fev1Ref);
        if (g) {
          sev = `${g.label} (FEV1 ${fev1Ref.toFixed(1)}%REF)`;
          sevClass = g.cls;
          setStep(step6,'completed'); setStep(step6,'active');
          detail = {
            show:true,
            chip:'Obstrucción · grado',
            mainLine:`• Obstrucción: ratio ${ratio.toFixed(2)}% < 70%.`,
            subLine:`• Grado por FEV1 %REF = ${fev1Ref.toFixed(1)}% → ${g.label.toUpperCase()}.`,
            note:``
          };
        } else {
          sev = 'Sin grado (falta FEV1 %REF)';
          setStep(step6,'active');
          detail = {
            show:true,
            chip:'Obstrucción',
            mainLine:`• Obstrucción: ratio ${ratio.toFixed(2)}% < 70%.`,
            subLine:`• Para grado, añade FEV1 %REF.`,
            note:``
          };
        }
      } else {
        if (!hasFvcRef) {
          patron = 'NO OBSTRUCCIÓN (falta FVC %REF para normal vs restrictivo sugerido)';
          setStep(step4,'active');
          setStep(step5,'completed'); setStep(step5,'active');
          setStep(step6,'active');
          detail = {
            show:true,
            chip:'Faltan datos',
            mainLine:`• NO obstrucción: ratio ${ratio.toFixed(2)}% ≥ 70%.`,
            subLine:`• Para cerrar patrón, añade FVC %REF.`,
            note:``
          };
        } else {
          setStep(step4,'completed'); setStep(step4,'active');
          if (fvcRef <= 80) {
            patron = 'RESTRICTIVO (sugerido)';
            sev = 'Confirmar con volúmenes/TLC si procede';
            detail = {
              show:true,
              chip:'Restricción sugerida',
              mainLine:`• NO obstrucción: ratio ${ratio.toFixed(2)}% ≥ 70%.`,
              subLine:`• FVC %REF ${fvcRef.toFixed(1)}% ≤80 → restricción sugerida.`,
              note:``
            };
          } else {
            patron = 'NORMAL';
            sev = 'Sin alteraciones (según cortes)';
            sevClass = 'normal';
            detail = {
              show:true,
              chip:'Normal',
              mainLine:`• NO obstrucción: ratio ${ratio.toFixed(2)}% ≥ 70%.`,
              subLine:`• FVC %REF ${fvcRef.toFixed(1)}% >80 → normal.`,
              note:`• Si hay síntomas, correlacionar (asma intercrisis puede ser normal).`
            };
          }
          setStep(step5,'completed'); setStep(step5,'active');
          setStep(step6,'completed'); setStep(step6,'active');
        }
      }

      current.patron = patron;
      current.severidad = sev;
      current.severidadClass = sevClass;
      renderGradeDetail(detail);

      showResult();
      updatePlan();
      drawChart();
    }

    function showResultNoInterpretable(){
      const patronDiv = document.getElementById('patron');
      const sevDiv = document.getElementById('severidad');
      patronDiv.textContent = 'NO INTERPRETABLE';
      patronDiv.classList.add('no-interpretable');
      sevDiv.textContent = 'Repetir espirometría (calidad/repetibilidad insuficiente)';
      sevDiv.className = 'severity';
      updateOutputs();
      updatePlan();
      drawChart();
    }

    function showResult(){
      const patronDiv = document.getElementById('patron');
      const sevDiv = document.getElementById('severidad');

      patronDiv.textContent = current.patron || 'PENDIENTE';
      patronDiv.classList.toggle('no-interpretable', current.patron === 'NO INTERPRETABLE');

      sevDiv.textContent = current.severidad || '';
      sevDiv.className = 'severity ' + (current.severidadClass || '');

      updateOutputs();
    }

    function toggleBD(){
      const content = document.getElementById('bdContent');
      const arrow = document.getElementById('bdArrow');
      if (!content || !arrow) return;
      content.classList.toggle('open');
      arrow.textContent = content.classList.contains('open') ? '▲' : '▼';
    }

    function calcularBD(){
      const pre = num('bdFev1Pre');
      const post = num('bdFev1Post');

      const bd = document.getElementById('bdresult');
      if (!bd) return;

      if (!pre || !post) {
        bd.textContent = 'No calculada';
        bd.style.background = '#000';
        current.bd = null;
        updatePlan();
        return;
      }

      if (!inRange(post, 0.20, 8.00)) {
        bd.textContent = 'POST fuera de rango';
        bd.style.background = '#DC2626';
        current.bd = null;
        updatePlan();
        return;
      }

      const cambioAbs = post - pre;
      const cambioPor = (cambioAbs / pre) * 100;
      const esPositiva = (cambioAbs >= 0.2) && (cambioPor >= 12);

      const absMl = Math.round(cambioAbs * 1000);
      const signo = (cambioPor >= 0) ? '+' : '';
      const res = esPositiva
        ? `POSITIVA (${signo}${cambioPor.toFixed(1)}%, ${absMl} ml)`
        : `NEGATIVA (${signo}${cambioPor.toFixed(1)}%, ${absMl} ml)`;

      bd.textContent = res;
      bd.style.background = esPositiva ? '#059669' : '#DC2626';

      current.bd = { pre, post, cambioAbs, cambioPor, esPositiva, absMl, texto: res };
      updatePlan();
    }

    function getBDLine(){
      if (!current.bd) return 'PBD: no realizada o no calculada.';
      return `PBD: ${current.bd.texto}  |  PRE=${current.bd.pre.toFixed(2)} L  POST=${current.bd.post.toFixed(2)} L`;
    }

    function buildGeneralPlan(){
      if (!hasEverCalculated) return 'Introduce valores, añade calidad y calcula.';

      if (current.interpretable === null) {
        return `CALIDAD: PENDIENTE

La app no interpreta ni propone manejo hasta confirmar calidad.
Siguiente paso:
- Marca “Calidad suficiente: Sí/No” o completa ATS/ERS (FVC+FEV1 + repetibilidad).`;
      }

      if (current.interpretable === false) {
        return `DX FUNCIONAL: NO INTERPRETABLE

No tomar decisiones basadas en esta prueba.
Siguiente paso:
- Repetir espirometría asegurando calidad y repetibilidad.`;
      }

      const patron = current.patron || '—';
      const sospecha = txt('sospecha');
      const contexto = txt('contexto');

      const ratio = num('ratioMF');
      const fvcRef = num('fvcRef');
      const fev1Ref = num('fev1Ref');

      const lines = [];
      lines.push(`DX FUNCIONAL: ${patron}`);
      if (current.severidad) lines.push(`Grado/nota: ${current.severidad}`);
      lines.push(getBDLine());
      lines.push('');
      lines.push('Lectura rápida:');
      if (ratio !== null) {
        lines.push(`- MFEV1/MFVC = ${ratio.toFixed(2)}%  → Obstrucción (corte 70): ${current.obstruccion === null ? '—' : (current.obstruccion ? 'SÍ' : 'NO')}`);
      }
      if (fvcRef !== null) lines.push(`- FVC %REF = ${fvcRef.toFixed(1)}%`);
      if (fev1Ref !== null) lines.push(`- FEV1 %REF = ${fev1Ref.toFixed(1)}%`);

      lines.push('');
      lines.push('Siguiente paso (operativo):');
      if (patron.includes('OBSTRUCTIVO')) {
        lines.push('- Correlacionar con clínica y exposición (asma/EPOC/solapamiento/otros).');
        lines.push('- Revisar técnica inhalatoria y adherencia antes de escalar tratamientos.');
        lines.push('- Si “mixto”: pensar atrapamiento vs restricción; si cambia conducta, plantear volúmenes (TLC).');
      } else if (patron.includes('RESTRICTIVO')) {
        lines.push('- Restricción sugerida: si cambia conducta, confirmar con volúmenes (TLC).');
        lines.push('- Revisar causas según clínica (obesidad, pared torácica, intersticial, neuromuscular).');
      } else if (patron.includes('NORMAL')) {
        lines.push('- Normal no excluye patología si síntomas: repetir en fase sintomática si sospecha alta.');
        lines.push('- Considerar otras causas de disnea (IC, anemia, obesidad, ansiedad, etc.).');
      } else {
        lines.push('- Falta algún dato clave para cerrar patrón (RATIO y/o FVC %REF).');
      }

      if (sospecha === 'asma') {
        lines.push('');
        lines.push('ASMA (orientación práctica):');
        lines.push('- PBD positiva apoya variabilidad; integrar con clínica típica.');
        lines.push('- PBD negativa NO excluye asma.');
        lines.push('- Prioridad: técnica/adherencia/desencadenantes/comorbilidades antes de escalar.');
      }

      if (sospecha === 'epoc') {
        lines.push('');
        lines.push('EPOC (orientación práctica):');
        lines.push('- Diagnóstico: obstrucción persistente + exposición + síntomas crónicos.');
        lines.push('- PBD positiva NO descarta EPOC.');
        lines.push('- Medidas base: tabaco, vacunación, actividad/rehab, técnica y adherencia.');
      }

      if (sospecha === 'otros') {
        lines.push('');
        lines.push('OTROS:');
        lines.push('- Útil en disnea crónica y seguimiento; la tendencia suele valer más que un valor aislado.');
        lines.push('- Si patrón no encaja, repetir o revalorar calidad/medición.');
      }

      lines.push('');
      lines.push(`Contexto: ${contexto === 'ap' ? 'Atención Primaria' : (contexto === 'seguimiento' ? 'Seguimiento' : 'Duda diagnóstica')}`);
      return lines.join('\n');
    }

    function updatePlan(){
      const box = document.getElementById('planBox');
      if (box) box.textContent = buildGeneralPlan();
    }

    function drawChart(){
      const canvas = document.getElementById('flowVolumeChart');
      if (!canvas) return;

      const ctx = canvas.getContext('2d');

      // si está oculto (móvil), no merece recalcular
      const style = window.getComputedStyle(canvas);
      if (style.display === 'none') return;

      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      const w = canvas.width, h = canvas.height;

      ctx.clearRect(0, 0, w, h);

      const pad = 20;
      const graphW = w - 2 * pad;
      const graphH = h - 2 * pad;

      const fvc = num('mejorFVC') || 0;
      const fev1 = num('mejorFEV1') || 0;

      const maxVol = Math.max(fvc, 6) * 1.1;
      const maxFlow = Math.max(fev1 * 4, 10);

      ctx.strokeStyle = '#000';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(pad, pad);
      ctx.lineTo(pad, h - pad);
      ctx.lineTo(w - pad, h - pad);
      ctx.stroke();

      ctx.strokeStyle = '#9CA3AF';
      ctx.lineWidth = 1.5;
      ctx.setLineDash([4, 3]);
      ctx.beginPath();
      for (let i = 0; i <= 100; i++) {
        const t = i / 100;
        const vol = 4 * t;
        const flow = maxFlow * 0.9 * Math.exp(-2.5 * t) * (1 - 0.1 * t);
        const x = pad + (vol / maxVol) * graphW;
        const y = h - pad - (flow / maxFlow) * graphH;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();

      const obstructivo = (current.obstruccion === true);
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 2.5;
      ctx.setLineDash([]);
      ctx.beginPath();
      for (let i = 0; i <= 100; i++) {
        const t = i / 100;
        const vol = (fvc || 0) * t;
        let flow;

        if (obstructivo) flow = maxFlow * 0.65 * Math.exp(-3.5 * t) * (1 + 0.3 * t);
        else flow = maxFlow * 0.85 * Math.exp(-2.5 * t) * (1 - 0.05 * t);

        const x = pad + (vol / maxVol) * graphW;
        const y = h - pad - (flow / maxFlow) * graphH;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();
    }

    function calcularTodo(){
      hasEverCalculated = true;
      autoFillRatioIfEmpty();
      current.fecha = new Date().toLocaleDateString('es-ES');
      updateATSSummary();
      calcularPatronYGrado();
      updatePlan();
    }

    function generarInforme(){
      if (!hasEverCalculated) {
        alert('Primero introduce valores y calcula.');
        return;
      }

      const lines = [];
      lines.push('INFORME DE ESPIROMETRÍA (resumen)');
      lines.push(`Fecha: ${current.fecha}`);
      lines.push('');

      lines.push('DATOS INTRODUCIDOS (PRE):');
      lines.push(`- Mejor FVC (l): ${num('mejorFVC') === null ? '—' : num('mejorFVC').toFixed(2)}`);
      lines.push(`- Mejor FEV1 (l): ${num('mejorFEV1') === null ? '—' : num('mejorFEV1').toFixed(2)}`);
      lines.push(`- MFEV1/MFVC (%): ${num('ratioMF') === null ? '—' : num('ratioMF').toFixed(2)}`);
      lines.push(`- FVC %REF: ${num('fvcRef') === null ? '—' : num('fvcRef').toFixed(1)}`);
      lines.push(`- FEV1 %REF: ${num('fev1Ref') === null ? '—' : num('fev1Ref').toFixed(1)}`);
      lines.push(`- FEF25%-75% %REF (opcional): ${num('fefRef') === null ? '—' : num('fefRef').toFixed(1)}`);
      lines.push('');

      lines.push('CALIDAD:');
      lines.push(`- Calidad suficiente (manual): ${txt('manualQuality') ? (txt('manualQuality')==='si'?'Sí':'No') : '— (ATS/ERS)'}`
      );
      lines.push(`- ATS/ERS: FVC ${txt('calidadFVC') || '—'} / FEV1 ${txt('calidadFEV1') || '—'} | Rep FVC ${txt('repFVC')||'—'} / Rep FEV1 ${txt('repFEV1')||'—'}`);
      lines.push('');

      const bdPre = num('bdFev1Pre');
      const bdPost = num('bdFev1Post');
      lines.push('PBD (si procede):');
      lines.push(`- Mejor FEV1 (l) PRE: ${bdPre === null ? '—' : bdPre.toFixed(2)}`);
      lines.push(`- Mejor FEV1 (l) POST: ${bdPost === null ? '—' : bdPost.toFixed(2)}`);
      lines.push('');

      lines.push('RESULTADOS CALCULADOS:');
      lines.push(`- INTERPRETABLE: ${current.interpretable === null ? '— (pendiente)' : (current.interpretable ? 'SÍ' : 'NO')}`);
      lines.push(`- Obstrucción (ratio <70): ${current.obstruccion === null ? '—' : (current.obstruccion ? 'SÍ' : 'NO')}`);
      lines.push(`- Patrón: ${current.patron || '—'}`);
      lines.push(`- Grado/nota: ${current.severidad || '—'}`);
      lines.push(`- ${getBDLine()}`);
      lines.push('');
      lines.push('ORIENTACIÓN CLÍNICA / PRÓXIMOS PASOS:');
      lines.push(buildGeneralPlan());

      document.getElementById('reportContent').textContent = lines.join('\n');
      document.getElementById('reportModal').style.display = 'flex';
    }

    function copiarInforme(){
      const texto = document.getElementById('reportContent').textContent;
      navigator.clipboard.writeText(texto).then(() => alert('Informe copiado'));
    }

    function openInfoTab(panelId){
      const panels = ['tabUse','tabQual','tabInterp','tabAsthma','tabCopd','tabOther'];
      const btns = {
        tabUse:'tabBtnUse', tabQual:'tabBtnQual', tabInterp:'tabBtnInterp',
        tabAsthma:'tabBtnAsthma', tabCopd:'tabBtnCopd', tabOther:'tabBtnOther'
      };

      panels.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.remove('active');
        const b = document.getElementById(btns[id]);
        if (b) b.classList.remove('active');
      });

      document.getElementById(panelId).classList.add('active');
      document.getElementById(btns[panelId]).classList.add('active');
    }

    function openInfoModal(){
      document.getElementById('infoModal').style.display = 'flex';
      openInfoTab('tabUse');
    }

    function openATSModal(){
      document.getElementById('atsModal').style.display = 'flex';
      updateATSSummary();
    }

    function closeModal(id){ document.getElementById(id).style.display = 'none'; }

    function clearAll(){
      [
        'mejorFVC','mejorFEV1','ratioMF','fvcRef','fev1Ref','fefRef',
        'bdFev1Post'
      ].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });

      ['manualQuality','calidadFVC','calidadFEV1','repFVC','repFEV1','sospecha','contexto'].forEach(id=>{
        const el = document.getElementById(id);
        if (!el) return;
        if (id==='sospecha') el.value = 'no';
        else if (id==='contexto') el.value = 'ap';
        else el.value = '';
      });

      setFieldError(null);

      const qw = document.getElementById('qualityWarning');
      if (qw) qw.classList.remove('show');

      const bd = document.getElementById('bdresult');
      if (bd){
        bd.textContent = 'No calculada';
        bd.style.background = '#000';
      }

      current = {
        fecha: new Date().toLocaleDateString('es-ES'),
        patron: null, severidad: null, severidadClass: '',
        obstruccion: null, interpretable: null, bd: null
      };
      hasEverCalculated = false;

      resetSteps();
      renderGradeDetail({show:false});
      const p = document.getElementById('patron');
      if (p){
        p.textContent = 'PENDIENTE';
        p.classList.remove('no-interpretable');
      }
      const s = document.getElementById('severidad');
      if (s){
        s.textContent = '';
        s.className = 'severity';
      }

      const plan = document.getElementById('planBox');
      if (plan) plan.textContent = 'Introduce valores, añade calidad y calcula.';

      updateOutputs();
      updateATSSummary();
      drawChart();

      // móvil vuelve a parámetros
      setMobilePanel('params');
    }

    window.onclick = function(event){
      if (event.target.classList.contains('modal-overlay')) event.target.style.display = 'none';
    }

    window.addEventListener('resize', () => drawChart());

    window.onload = function(){
      resetSteps();
      updateOutputs();
      updateATSSummary();
      drawChart();

      // móvil: panel inicial params
      setMobilePanel('params');
    };
  </script>
</body>
</html>
