<!-- PARTE 1/2 · HTML + CSS  -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interpretación de Espirometría (rápida)</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      overflow: hidden;
      overscroll-behavior: none;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      inset: 0;
      width: 100%;
      overflow: hidden;
      background: linear-gradient(135deg,
        rgba(245, 199, 66, 0.95) 0%,
        rgba(245, 199, 66, 0.88) 36%,
        rgba(255, 255, 255, 0.72) 52%,
        rgba(58, 160, 118, 0.88) 68%,
        rgba(58, 160, 118, 0.95) 100%);
      color: #000;
      position: relative;
    }

    body::before{
      content:"";
      position: fixed;
      inset: 0;
      background-image: url("logo-pulmones.png");
      background-repeat: no-repeat;
      background-position: center;
      background-size: min(680px, 70vw);
      opacity: 0.06;
      pointer-events: none;
      z-index: 0;
      filter: saturate(1.15) contrast(1.08);
    }

    .container {
      height: 100dvh;
      display: flex;
      flex-direction: column;
      padding: 10px;
      gap: 8px;
      position: relative;
      z-index: 1;
      min-height: 0;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.92);
      padding: 8px 16px;
      border-radius: 10px;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.10);
      flex-shrink: 0;
    }

    .title-wrap{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .app-logo{
      width: 34px;
      height: 34px;
      border-radius: 9px;
      object-fit: cover;
      border: 2px solid #000;
      background: #fff;
      flex: 0 0 auto;
    }
    h1 { font-size: 1.05rem; font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .header-buttons { display: flex; gap: 8px; }
    button.icon-btn {
      width: 32px; height: 32px;
      border-radius: 50%;
      border: none;
      background: #000;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
    }
    button.icon-btn:hover { transform: scale(1.06); }

    .desktop-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1.25fr 0.95fr;
      gap: 8px;
      flex: 1;
      min-height: 0;
    }

    .mobile-steps {
      display: none;
      flex: 1;
      min-height: 0;
      position: relative;
      overflow: hidden;
    }
    .screen {
      display: none;
      height: 100%;
      min-height: 0;
    }
    .screen.active { display: block; }

    @media (max-width: 1024px) {
      .desktop-grid { display: none; }
      .mobile-steps { display: block; }
    }

    .card {
      background: rgba(255, 255, 255, 0.92);
      border-radius: 10px;
      padding: 12px;
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      min-height: 0;
      height: 100%;
    }

    /* FIX: en escritorio, permitir scroll interno en las cards (evita “botones cortados” en iPad) */
    .desktop-grid .card{
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 14px;
    }

    @media (max-width: 1024px){
      .mobile-steps .card{
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: calc(14px + env(safe-area-inset-bottom));
      }
    }

    .card h2 {
      font-size: 0.9rem;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 2px solid #000;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      flex-shrink: 0;
    }

    .input-group { margin-bottom: 8px; }
    .input-group label {
      display: block;
      font-size: 0.8rem;
      font-weight: 800;
      margin-bottom: 3px;
    }
    .input-group input, .input-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #000;
      border-radius: 6px;
      background: #fff;
      font-size: 0.92rem;
      color: #000;
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .hint {
      margin-top: 8px;
      font-size: 0.78rem;
      line-height: 1.25;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #9CA3AF;
      background: #F9FAFB;
      color: #374151;
    }
    .tiny {
      font-size: 0.75rem;
      color: #374151;
      line-height: 1.2;
      margin-top: 5px;
    }

    .quality-warning {
      background: #FEF3C7;
      border: 1px solid #F59E0B;
      color: #92400E;
      padding: 12px;
      border-radius: 10px;
      font-size: 0.8rem;
      margin-top: 10px;
      display: none;
      line-height: 1.25;
    }
    .quality-warning.show { display: block; }

    .field-error{
      margin-top: 10px;
      font-size: 0.8rem;
      line-height: 1.25;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #DC2626;
      background: rgba(220,38,38,0.08);
      color: #7F1D1D;
      display: none;
      white-space: pre-wrap;
    }
    .field-error.show{ display:block; }

    .result-display { font-size: 0.88rem; line-height: 1.3; }
    .result-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      padding: 4px 0;
      border-bottom: 1px dotted rgba(0,0,0,0.2);
      gap: 10px;
    }
    .result-value { font-weight: 900; text-align: right; white-space: nowrap; }

    .pattern-box {
      background: #000;
      color: #fff;
      padding: 12px;
      border-radius: 10px;
      text-align: center;
      margin-top: 10px;
      font-weight: 900;
      font-size: 1.05rem;
      letter-spacing: 0.2px;
    }
    .pattern-box.no-interpretable { background: #DC2626; }

    .severity {
      font-size: 0.85rem;
      padding: 10px;
      border-radius: 10px;
      margin-top: 8px;
      text-align: center;
      font-weight: 900;
    }
    .severity.normal { background: #6EE7B7; color: #000; }
    .severity.leve { background: #FDE047; color: #000; }
    .severity.moderado { background: #FB923C; color: #000; }
    .severity.severo { background: #F87171; color: #fff; }
    .severity.muy-severo { background: #DC2626; color: #fff; }

    .grade-detail{
      margin-top: 10px;
      padding: 10px;
      border-radius: 10px;
      border: 1px dashed #000;
      background: rgba(255,255,255,0.85);
      font-size: 0.8rem;
      line-height: 1.28;
      color: #111827;
      display: none;
      white-space: pre-wrap;
    }
    .grade-detail.show{ display:block; }
    .grade-detail .k { font-weight: 900; }
    .grade-chip{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #000;
      background:#fff;
      font-weight:900;
      font-size: 0.75rem;
      margin-left: 6px;
    }

    .plan-section{
      margin-top: 12px;
      padding-top: 12px;
      border-top: 2px solid #000;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
    }
    .plan-title{
      font-size: 0.85rem;
      font-weight: 900;
      letter-spacing: 0.2px;
      text-transform: uppercase;
    }
    .plan-note{
      font-size: 0.78rem;
      color: #374151;
      line-height: 1.25;
    }
    .plan-box{
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px;
      font-size: 0.86rem;
      color: #111827;
      line-height: 1.35;
      overflow: hidden;
      white-space: pre-wrap;
      flex: 1;
    }

    .bd-result {
      background: #000;
      color: #fff;
      padding: 10px;
      border-radius: 10px;
      text-align: center;
      margin-top: 10px;
      font-size: 0.92rem;
      font-weight: 900;
    }

    .step-footer{
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    @media (max-width: 1024px){
      .step-footer{
        position: sticky;
        bottom: 0;
        padding-top: 10px;
        padding-bottom: calc(8px + env(safe-area-inset-bottom));
        background: rgba(255,255,255,0.92);
        backdrop-filter: blur(8px);
        border-top: 1px dashed rgba(0,0,0,0.25);
        z-index: 5;
      }
      .btn-primary, .btn-secondary{
        flex: 1 1 0;
        min-width: 0;
      }
    }

    .btn-primary{
      background: #000;
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 900;
      font-size: 0.92rem;
      flex: 1;
      min-width: 160px;
    }
    .btn-secondary{
      background: #fff;
      color: #000;
      border: 2px solid #000;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 900;
      font-size: 0.92rem;
      flex: 0 0 auto;
    }
    .btn-primary:disabled{
      opacity: .55;
      cursor: not-allowed;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal {
      background: #fff;
      border-radius: 12px;
      padding: 18px;
      max-width: 920px;
      width: 92%;
      max-height: 85vh;
      overflow-y: auto;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 14px;
      font-size: 22px;
      cursor: pointer;
      background: none;
      border: none;
    }
    .modal h3 { margin-bottom: 12px; font-size: 1.1rem; }

    .report-text {
      background: #f3f4f6;
      padding: 14px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 0.78rem;
      white-space: pre-wrap;
      margin-top: 12px;
      border: 1px solid #000;
    }
    .copy-btn {
      background: #000;
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 10px;
      font-weight: 900;
    }

    .locked {
      opacity: 0.55;
      filter: grayscale(0.15);
      pointer-events: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="title-wrap">
        <img class="app-logo" src="logo-pulmones.png" alt="Logo pulmones">
        <h1>Interpretación de Espirometría (rápida)</h1>
      </div>
      <div class="header-buttons">
        <button class="icon-btn" onclick="openInfoModal()" title="Información">ℹ</button>
        <button class="icon-btn" onclick="clearAll()" title="Limpiar todo">L</button>
      </div>
    </header>

    <div class="desktop-grid">
      <!-- CALIDAD -->
      <div class="card" id="deskQuality">
        <h2>Calidad</h2>

        <div class="input-group">
          <label>Calidad suficiente (según tú / informe)</label>
          <select id="manualQuality" onchange="calcularTodo()">
            <option value="">— (usar ATS/ERS)</option>
            <option value="si">Sí (interpretable)</option>
            <option value="no">No (no interpretable)</option>
          </select>
          <div class="tiny">Si marcas Sí/No, ATS/ERS no hace falta. Si lo dejas en “—”, ATS/ERS debe estar completo.</div>
        </div>

        <div style="margin-top: 6px; padding-top: 6px; border-top: 1px dashed #000;">
          <div class="input-row">
            <div class="input-group">
              <label>Grado ATS/ERS: FVC</label>
              <select id="calidadFVC" onchange="calcularTodo()">
                <option value="">—</option>
                <option value="A">A</option><option value="B">B</option><option value="C">C</option>
                <option value="D">D</option><option value="E">E</option>
                <option value="F">F</option>
              </select>
            </div>
            <div class="input-group">
              <label>Grado ATS/ERS: FEV1</label>
              <select id="calidadFEV1" onchange="calcularTodo()">
                <option value="">—</option>
                <option value="A">A</option><option value="B">B</option><option value="C">C</option>
                <option value="D">D</option><option value="E">E</option>
                <option value="F">F</option>
              </select>
            </div>
          </div>

          <div class="input-row">
            <div class="input-group">
              <label>Reproducibilidad: FVC</label>
              <select id="repFVC" onchange="calcularTodo()">
                <option value="">—</option>
                <option value="si">Sí</option>
                <option value="no">No</option>
              </select>
            </div>
            <div class="input-group">
              <label>Reproducibilidad: FEV1</label>
              <select id="repFEV1" onchange="calcularTodo()">
                <option value="">—</option>
                <option value="si">Sí</option>
                <option value="no">No</option>
              </select>
            </div>
          </div>

          <div class="hint">
            Regla operativa:
            <br>• <strong>NO interpretable</strong> si calidad "F" o reproducibilidad "No" en FVC o FEV1.
            <br>• Si faltan datos → "pendiente" (la app NO interpreta).
          </div>
        </div>

        <div class="quality-warning" id="qualityWarning">
          <strong>NO INTERPRETABLE.</strong>
          <br>Evita decisiones basadas en esta prueba. Repetir asegurando calidad y reproducibilidad.
        </div>
      </div>

      <!-- PARÁMETROS -->
      <div class="card" id="deskParams">
        <h2>Parámetros (PRE)</h2>

        <div class="input-row">
          <div class="input-group">
            <label>Mejor FVC (l)</label>
            <input type="text" id="mejorFVC" inputmode="decimal" placeholder="Ej: 4,85"
                   oninput="sanitizeDecimal(this); calcularTodo()">
          </div>
          <div class="input-group">
            <label>Mejor FEV1 (l)</label>
            <input type="text" id="mejorFEV1" inputmode="decimal" placeholder="Ej: 3,11"
                   oninput="sanitizeDecimal(this); calcularTodo()">
          </div>
        </div>

        <div class="input-group">
          <label>MFEV1/MFVC (%)</label>
          <input type="text" id="ratioMF" inputmode="decimal" placeholder="Del informe"
                 oninput="sanitizeDecimal(this); calcularTodo()">
          <div class="tiny">Si metes FEV1 y FVC, se autocalcula si este campo está vacío.</div>
        </div>

        <div class="input-row">
          <div class="input-group">
            <label>FVC %REF</label>
            <input type="text" id="fvcRef" inputmode="decimal" placeholder="Ej: 95"
                   oninput="sanitizeDecimal(this); calcularTodo()">
          </div>
          <div class="input-group">
            <label>FEV1 %REF</label>
            <input type="text" id="fev1Ref" inputmode="decimal" placeholder="Ej: 68"
                   oninput="sanitizeDecimal(this); calcularTodo()">
          </div>
        </div>

        <div class="input-group">
          <label>FEF25%-75% %REF (opcional)</label>
          <input type="text" id="fefRef" inputmode="decimal" placeholder="Ej: 81"
                 oninput="sanitizeDecimal(this); calcularTodo()">
        </div>

        <div class="field-error" id="fieldError"></div>

        <div class="hint">
          Para patrón rápido suele bastar con:
          <br>• <strong>RATIO</strong> (corte fijo 70)
          <br>• <strong>FVC %REF</strong> (80)
          <br>El <strong>grado</strong> (si hay obstrucción) usa <strong>FEV1 %REF</strong>.
        </div>
      </div>

      <!-- DIAGNÓSTICO + MANEJO -->
      <div class="card" id="deskInterp">
        <h2>Diagnóstico + Manejo</h2>

        <div class="result-display">
          <div class="result-item"><span>INTERPRETABLE</span><span class="result-value" id="outInterpretable">—</span></div>
          <div class="result-item"><span>Obstrucción (ratio &lt; 70)</span><span class="result-value" id="outObstruccion">—</span></div>
          <div class="result-item"><span>MFEV1/MFVC (%)</span><span class="result-value" id="outRatio">—</span></div>
          <div class="result-item"><span>FVC %REF</span><span class="result-value" id="outFvcRef">—</span></div>
          <div class="result-item"><span>FEV1 %REF</span><span class="result-value" id="outFev1Ref">—</span></div>
          <div class="result-item"><span>FEF25%-75% %REF (opc)</span><span class="result-value" id="outFefRef">—</span></div>
        </div>

        <div class="pattern-box" id="patron">PENDIENTE</div>
        <div class="severity" id="severidad"></div>
        <div class="grade-detail" id="gradoDetalle"></div>

        <div class="plan-section">
          <div class="plan-title">Plan (operativo)</div>
          <div class="plan-note">Si la prueba no es válida, no se propone plan. La clínica manda.</div>

          <div class="input-row">
            <div class="input-group">
              <label>Sospecha clínica</label>
              <select id="sospecha" onchange="updatePlan()">
                <option value="no">No especificada</option>
                <option value="epoc">EPOC</option>
                <option value="asma">Asma</option>
                <option value="otros">Otros</option>
              </select>
            </div>
            <div class="input-group">
              <label>Contexto</label>
              <select id="contexto" onchange="updatePlan()">
                <option value="ap">Atención Primaria</option>
                <option value="seguimiento">Seguimiento</option>
                <option value="diagnostico">Duda diagnóstica</option>
              </select>
            </div>
          </div>

          <div class="plan-box" id="planBox">Introduce valores, añade calidad y calcula.</div>

          <div class="step-footer" style="margin-top: 10px;">
            <button class="btn-primary" onclick="generarInforme()">VER INFORME</button>
          </div>
        </div>
      </div>

      <!-- PBD -->
      <div class="card" id="deskBD">
        <h2>Prueba Broncodilatadora</h2>

        <div class="hint" style="margin-bottom: 10px;">
          Criterios implementados:
          <br>• <strong>Clásico</strong>: ΔFEV1 ≥200 ml y ≥12% respecto a PRE.
          <br>• <strong>Alternativo</strong> (si hay FEV1 %REF): ΔFEV1 &gt;10% del FEV1 predicho (inferido).
        </div>

        <div class="input-group">
          <label>Mejor FEV1 (l) PRE</label>
          <input type="text" id="bdFev1Pre" inputmode="decimal" readonly>
        </div>

        <div class="input-group">
          <label>Mejor FEV1 (l) POST</label>
          <input type="text" id="bdFev1Post" inputmode="decimal" placeholder="Del informe post"
                 oninput="sanitizeDecimal(this); calcularBD()">
        </div>

        <div class="bd-result" id="bdresult">No calculada</div>

        <div class="hint" style="margin-top:10px;">
          <strong>Interpretación rápida:</strong><br>
          • Positiva: variabilidad del flujo (apoya asma/solapamiento)<br>
          • Negativa: NO excluye asma ni EPOC<br>
          • Siempre correlacionar con clínica
        </div>
      </div>
    </div>

    <!-- MÓVIL -->
    <div class="mobile-steps">
      <section class="screen active" id="screen1">
        <div class="card">
          <h2>Paso 1 · Calidad</h2>

          <div class="input-group">
            <label>Calidad suficiente (según tú / informe)</label>
            <select id="m_manualQuality" onchange="syncMobileToDesktop('manualQuality', this.value); calcularTodo();">
              <option value="">— (usar ATS/ERS)</option>
              <option value="si">Sí (interpretable)</option>
              <option value="no">No (no interpretable)</option>
            </select>
            <div class="tiny">Si marcas Sí/No, ATS/ERS no hace falta. Si lo dejas en “—”, completa ATS/ERS.</div>
          </div>

          <div style="margin-top: 6px; padding-top: 6px; border-top: 1px dashed #000;">
            <div class="input-row">
              <div class="input-group">
                <label>Grado ATS/ERS: FVC</label>
                <select id="m_calidadFVC" onchange="syncMobileToDesktop('calidadFVC', this.value); calcularTodo();">
                  <option value="">—</option>
                  <option value="A">A</option><option value="B">B</option><option value="C">C</option>
                  <option value="D">D</option><option value="E">E</option>
                  <option value="F">F</option>
                </select>
              </div>
              <div class="input-group">
                <label>Grado ATS/ERS: FEV1</label>
                <select id="m_calidadFEV1" onchange="syncMobileToDesktop('calidadFEV1', this.value); calcularTodo();">
                  <option value="">—</option>
                  <option value="A">A</option><option value="B">B</option><option value="C">C</option>
                  <option value="D">D</option><option value="E">E</option>
                  <option value="F">F</option>
                </select>
              </div>
            </div>

            <div class="input-row">
              <div class="input-group">
                <label>Reproducibilidad: FVC</label>
                <select id="m_repFVC" onchange="syncMobileToDesktop('repFVC', this.value); calcularTodo();">
                  <option value="">—</option>
                  <option value="si">Sí</option>
                  <option value="no">No</option>
                </select>
              </div>
              <div class="input-group">
                <label>Reproducibilidad: FEV1</label>
                <select id="m_repFEV1" onchange="syncMobileToDesktop('repFEV1', this.value); calcularTodo();">
                  <option value="">—</option>
                  <option value="si">Sí</option>
                  <option value="no">No</option>
                </select>
              </div>
            </div>

            <div class="hint">
              NO interpretable si calidad "F" o reproducibilidad "No" en FVC o FEV1.
              Si faltan datos → pendiente.
            </div>
          </div>

          <div class="quality-warning" id="m_qualityWarning">
            <strong>NO INTERPRETABLE.</strong>
            <br>Repetir asegurando calidad y reproducibilidad.
          </div>

          <div class="step-footer">
            <button class="btn-primary" id="btnContinue1" onclick="goNextFromQuality()">CONTINUAR</button>
          </div>
        </div>
      </section>

      <section class="screen" id="screen2">
        <div class="card">
          <h2>Paso 2 · Parámetros</h2>

          <div class="input-row">
            <div class="input-group">
              <label>Mejor FVC (l)</label>
              <input type="text" id="m_mejorFVC" inputmode="decimal" placeholder="Ej: 4,85"
                oninput="sanitizeDecimal(this); syncMobileToDesktop('mejorFVC', this.value); calcularTodo();">
            </div>
            <div class="input-group">
              <label>Mejor FEV1 (l)</label>
              <input type="text" id="m_mejorFEV1" inputmode="decimal" placeholder="Ej: 3,11"
                oninput="sanitizeDecimal(this); syncMobileToDesktop('mejorFEV1', this.value); calcularTodo();">
            </div>
          </div>

          <div class="input-group">
            <label>MFEV1/MFVC (%)</label>
            <input type="text" id="m_ratioMF" inputmode="decimal" placeholder="Del informe"
              oninput="sanitizeDecimal(this); syncMobileToDesktop('ratioMF', this.value); calcularTodo();">
            <div class="tiny">Si FEV1 y FVC están, se autocalcula si este campo está vacío.</div>
          </div>

          <div class="input-row">
            <div class="input-group">
              <label>FVC %REF</label>
              <input type="text" id="m_fvcRef" inputmode="decimal" placeholder="Ej: 95"
                oninput="sanitizeDecimal(this); syncMobileToDesktop('fvcRef', this.value); calcularTodo();">
            </div>
            <div class="input-group">
              <label>FEV1 %REF</label>
              <input type="text" id="m_fev1Ref" inputmode="decimal" placeholder="Ej: 68"
                oninput="sanitizeDecimal(this); syncMobileToDesktop('fev1Ref', this.value); calcularTodo();">
            </div>
          </div>

          <div class="input-group">
            <label>FEF25%-75% %REF (opcional)</label>
            <input type="text" id="m_fefRef" inputmode="decimal" placeholder="Ej: 81"
              oninput="sanitizeDecimal(this); syncMobileToDesktop('fefRef', this.value); calcularTodo();">
          </div>

          <div class="field-error" id="m_fieldError"></div>

          <div class="hint">
            Para cerrar patrón rápido:
            <br>• RATIO (corte 70)
            <br>• FVC %REF (80)
            <br>Grado por FEV1 %REF si obstrucción.
          </div>

          <div class="step-footer">
            <button class="btn-secondary" onclick="goStep(1)">ATRÁS</button>
            <button class="btn-primary" onclick="goNextFromParams()">INTERPRETAR</button>
          </div>
        </div>
      </section>

      <section class="screen" id="screen3">
        <div class="card">
          <h2>Paso 3 · Diagnóstico</h2>

          <div class="result-display">
            <div class="result-item"><span>INTERPRETABLE</span><span class="result-value" id="m_outInterpretable">—</span></div>
            <div class="result-item"><span>Obstrucción (ratio &lt; 70)</span><span class="result-value" id="m_outObstruccion">—</span></div>
            <div class="result-item"><span>MFEV1/MFVC (%)</span><span class="result-value" id="m_outRatio">—</span></div>
            <div class="result-item"><span>FVC %REF</span><span class="result-value" id="m_outFvcRef">—</span></div>
            <div class="result-item"><span>FEV1 %REF</span><span class="result-value" id="m_outFev1Ref">—</span></div>
          </div>

          <div class="pattern-box" id="m_patron">PENDIENTE</div>
          <div class="severity" id="m_severidad"></div>
          <div class="grade-detail" id="m_gradoDetalle"></div>

          <div class="step-footer">
            <button class="btn-secondary" onclick="goStep(2)">ATRÁS</button>
            <button class="btn-primary" onclick="goNextToBD()">PBD</button>
          </div>
        </div>
      </section>

      <section class="screen" id="screen4">
        <div class="card">
          <h2>Paso 4 · Prueba broncodilatadora</h2>

          <div class="hint">
            Criterios:
            <br>• Clásico: ΔFEV1 ≥200 ml y ≥12% vs PRE.
            <br>• Alternativo (si hay FEV1 %REF): ΔFEV1 &gt;10% del predicho.
          </div>

          <div class="input-group">
            <label>Mejor FEV1 (l) PRE</label>
            <input type="text" id="m_bdFev1Pre" inputmode="decimal" readonly>
          </div>

          <div class="input-group">
            <label>Mejor FEV1 (l) POST</label>
            <input type="text" id="m_bdFev1Post" inputmode="decimal" placeholder="Del informe post"
              oninput="sanitizeDecimal(this); syncMobileToDesktop('bdFev1Post', this.value); calcularBD();">
          </div>

          <div class="bd-result" id="m_bdresult">No calculada</div>

          <div class="step-footer">
            <button class="btn-secondary" onclick="goStep(3)">ATRÁS</button>
            <button class="btn-primary" onclick="goNextToPlan()">VER MANEJO</button>
          </div>
        </div>
      </section>

      <section class="screen" id="screen5">
        <div class="card">
          <h2>Paso 5 · Manejo</h2>

          <div class="input-row">
            <div class="input-group">
              <label>Sospecha clínica</label>
              <select id="m_sospecha" onchange="syncMobileToDesktop('sospecha', this.value); updatePlan();">
                <option value="no">No especificada</option>
                <option value="epoc">EPOC</option>
                <option value="asma">Asma</option>
                <option value="otros">Otros</option>
              </select>
            </div>
            <div class="input-group">
              <label>Contexto</label>
              <select id="m_contexto" onchange="syncMobileToDesktop('contexto', this.value); updatePlan();">
                <option value="ap">Atención Primaria</option>
                <option value="seguimiento">Seguimiento</option>
                <option value="diagnostico">Duda diagnóstica</option>
              </select>
            </div>
          </div>

          <div class="plan-section" style="margin-top: 0; padding-top: 0; border-top: none;">
            <div class="plan-title">Orientación y pasos</div>
            <div class="plan-note">Se bloquea si la prueba no es válida.</div>
            <div class="plan-box" id="m_planBox">—</div>
          </div>

          <div class="step-footer">
            <button class="btn-secondary" onclick="goStep(4)">ATRÁS</button>
            <button class="btn-primary" onclick="goStep(6)">INFORME FINAL</button>
          </div>
        </div>
      </section>

      <section class="screen" id="screen6">
        <div class="card">
          <h2>Paso 6 · Informe final</h2>

          <div class="hint">Resumen autocopiable. Si NO interpretable, el informe se limita a “repetir”.</div>

          <pre class="report-text" id="m_reportContent"></pre>

          <div class="step-footer">
            <button class="btn-secondary" onclick="goStep(5)">ATRÁS</button>
            <button class="btn-primary" onclick="copiarInformeMovil()">COPIAR</button>
          </div>
        </div>
      </section>
    </div>

    <div style="text-align:right; font-size:.72rem; font-weight:600; color:#000; padding: 0 6px; flex-shrink:0;">
      Hecho por Guillermo J. Olivero Sanjuanelo
    </div>
  </div>

  <!-- MODAL INFORME -->
  <div class="modal-overlay" id="reportModal">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('reportModal')">X</button>
      <h3>Informe (resumen)</h3>
      <pre class="report-text" id="reportContent"></pre>
      <button class="copy-btn" onclick="copiarInforme()">Copiar</button>
    </div>
  </div>

  <!-- MODAL INFO -->
  <div class="modal-overlay" id="infoModal">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('infoModal')">X</button>
      <h3>Guía rápida (qué meter y cómo leerlo)</h3>

      <div class="hint">
        <strong>A) Qué datos son “imprescindibles”</strong><br>
        • 1) <strong>Calidad</strong>: marca “Sí/No” (o completa ATS/ERS + reproducibilidad).<br>
        • 2) <strong>RATIO</strong> (FEV1/FVC): del informe. Si metes FEV1 y FVC, la app lo calcula si lo dejas vacío.<br>
        • 3) <strong>FVC %REF</strong>: para diferenciar “normal” vs “restrictivo sugerido” y matizar si hay FVC baja.<br>
        • 4) <strong>FEV1 %REF</strong>: solo para <strong>grado</strong> si hay obstrucción.<br><br>

        <strong>B) Algoritmo (lo que hace la app)</strong><br>
        1) Si <strong>NO interpretable</strong> → no se interpreta, se recomienda repetir.<br>
        2) Si interpretable:<br>
        • Si <strong>RATIO &lt; 70</strong> → <strong>OBSTRUCTIVO</strong>.<br>
        &nbsp;&nbsp;↳ si además <strong>FVC %REF ≤80</strong> → “Obstructivo con FVC baja” (atrapamiento vs mixto).<br>
        • Si <strong>RATIO ≥ 70</strong> → NO obstrucción.<br>
        &nbsp;&nbsp;↳ si <strong>FVC %REF ≤80</strong> → <strong>Restrictivo sugerido</strong>.<br>
        &nbsp;&nbsp;↳ si <strong>FVC %REF &gt;80</strong> → <strong>Normal</strong> (según cortes).<br><br>

        <strong>C) PBD (post broncodilatador)</strong><br>
        • Úsala como <strong>variabilidad</strong>: una PBD positiva apoya asma/solapamiento, pero una negativa NO excluye asma ni EPOC.<br><br>

        <strong>D) Limitaciones (para no engañarte)</strong><br>
        • “Normal” no excluye asma entre crisis si la clínica encaja.<br>
        • “Restrictivo sugerido” no confirma restricción: si cambia conducta, confirma con volúmenes (TLC).<br>
        • “Obstructivo con FVC baja”: puede ser atrapamiento (pseudo-restricción) o mixto; si importa, confirma con volúmenes.<br><br>

        <strong>E) Derivar / ampliar estudio (reglas simples)</strong><br>
        • Prueba repetida no interpretable / técnica imposible.<br>
        • Duda diagnóstica que cambia tratamiento.<br>
        • Obstrucción moderada-grave con síntomas relevantes o exacerbaciones repetidas.<br>
        • Sospecha de restricción real o patrón mixto que condiciona decisiones.
      </div>
    </div>
  </div>

  <!-- El JS va en la PARTE 2/2 -->
  <script src="app.js"></script>
</body>
</html>
