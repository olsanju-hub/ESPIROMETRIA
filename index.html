<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interpretación de Espirometría (rápida)</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      overflow: hidden;
      overscroll-behavior: none;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      inset: 0;
      width: 100%;
      overflow: hidden;
      background: linear-gradient(135deg,
        rgba(245, 199, 66, 0.95) 0%,
        rgba(245, 199, 66, 0.88) 36%,
        rgba(255, 255, 255, 0.72) 52%,
        rgba(58, 160, 118, 0.88) 68%,
        rgba(58, 160, 118, 0.95) 100%);
      color: #000;
      position: relative;
    }

    body::before{
      content:"";
      position: fixed;
      inset: 0;
      background-image: url("logo-pulmones.png");
      background-repeat: no-repeat;
      background-position: center;
      background-size: min(680px, 70vw);
      opacity: 0.06;
      pointer-events: none;
      z-index: 0;
      filter: saturate(1.15) contrast(1.08);
    }

    .container {
      height: 100dvh;
      display: flex;
      flex-direction: column;
      padding: 10px;
      gap: 8px;
      position: relative;
      z-index: 1;
      min-height: 0;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.92);
      padding: 8px 16px;
      border-radius: 10px;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.10);
      flex-shrink: 0;
    }

    .title-wrap{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .app-logo{
      width: 34px;
      height: 34px;
      border-radius: 9px;
      object-fit: cover;
      border: 2px solid #000;
      background: #fff;
      flex: 0 0 auto;
    }
    h1 { font-size: 1.05rem; font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .header-buttons { display: flex; gap: 8px; }
    button.icon-btn {
      width: 32px; height: 32px;
      border-radius: 50%;
      border: none;
      background: #000;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
    }
    button.icon-btn:hover { transform: scale(1.06); }

    .desktop-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1.25fr 0.95fr;
      gap: 8px;
      flex: 1;
      min-height: 0;
    }

    .mobile-steps {
      display: none;
      flex: 1;
      min-height: 0;
      position: relative;
      overflow: hidden;
    }
    .screen {
      display: none;
      height: 100%;
      min-height: 0;
    }
    .screen.active { display: block; }

    @media (max-width: 1024px) {
      .desktop-grid { display: none; }
      .mobile-steps { display: block; }
    }

    .card {
      background: rgba(255, 255, 255, 0.92);
      border-radius: 10px;
      padding: 12px;
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      min-height: 0;
      height: 100%;
    }

    /* móvil: scroll dentro de la tarjeta */
    @media (max-width: 1024px){
      .mobile-steps .card{
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: calc(14px + env(safe-area-inset-bottom));
      }
    }

    .card h2 {
      font-size: 0.9rem;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 2px solid #000;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      flex-shrink: 0;
    }

    .input-group { margin-bottom: 8px; }
    .input-group label {
      display: block;
      font-size: 0.8rem;
      font-weight: 800;
      margin-bottom: 3px;
    }
    .input-group input, .input-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #000;
      border-radius: 6px;
      background: #fff;
      font-size: 0.92rem;
      color: #000;
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .hint {
      margin-top: 8px;
      font-size: 0.78rem;
      line-height: 1.25;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #9CA3AF;
      background: #F9FAFB;
      color: #374151;
    }
    .tiny {
      font-size: 0.75rem;
      color: #374151;
      line-height: 1.2;
      margin-top: 5px;
    }

    .quality-warning {
      background: #FEF3C7;
      border: 1px solid #F59E0B;
      color: #92400E;
      padding: 12px;
      border-radius: 10px;
      font-size: 0.8rem;
      margin-top: 10px;
      display: none;
      line-height: 1.25;
    }
    .quality-warning.show { display: block; }

    .field-error{
      margin-top: 10px;
      font-size: 0.8rem;
      line-height: 1.25;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #DC2626;
      background: rgba(220,38,38,0.08);
      color: #7F1D1D;
      display: none;
      white-space: pre-wrap;
    }
    .field-error.show{ display:block; }

    .result-display { font-size: 0.88rem; line-height: 1.3; }
    .result-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      padding: 4px 0;
      border-bottom: 1px dotted rgba(0,0,0,0.2);
      gap: 10px;
    }
    .result-value { font-weight: 900; text-align: right; white-space: nowrap; }

    .pattern-box {
      background: #000;
      color: #fff;
      padding: 12px;
      border-radius: 10px;
      text-align: center;
      margin-top: 10px;
      font-weight: 900;
      font-size: 1.05rem;
      letter-spacing: 0.2px;
    }
    .pattern-box.no-interpretable { background: #DC2626; }

    .severity {
      font-size: 0.85rem;
      padding: 10px;
      border-radius: 10px;
      margin-top: 8px;
      text-align: center;
      font-weight: 900;
    }
    .severity.normal { background: #6EE7B7; color: #000; }
    .severity.leve { background: #FDE047; color: #000; }
    .severity.moderado { background: #FB923C; color: #000; }
    .severity.severo { background: #F87171; color: #fff; }
    .severity.muy-severo { background: #DC2626; color: #fff; }

    .grade-detail{
      margin-top: 10px;
      padding: 10px;
      border-radius: 10px;
      border: 1px dashed #000;
      background: rgba(255,255,255,0.85);
      font-size: 0.8rem;
      line-height: 1.28;
      color: #111827;
      display: none;
      white-space: pre-wrap;
    }
    .grade-detail.show{ display:block; }
    .grade-detail .k { font-weight: 900; }
    .grade-chip{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #000;
      background:#fff;
      font-weight:900;
      font-size: 0.75rem;
      margin-left: 6px;
    }

    .plan-section{
      margin-top: 12px;
      padding-top: 12px;
      border-top: 2px solid #000;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
    }
    .plan-title{
      font-size: 0.85rem;
      font-weight: 900;
      letter-spacing: 0.2px;
      text-transform: uppercase;
    }
    .plan-note{
      font-size: 0.78rem;
      color: #374151;
      line-height: 1.25;
    }
    .plan-box{
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px;
      font-size: 0.86rem;
      color: #111827;
      line-height: 1.35;
      overflow: hidden;
      white-space: pre-wrap;
      flex: 1;
    }

    .bd-result {
      background: #000;
      color: #fff;
      padding: 10px;
      border-radius: 10px;
      text-align: center;
      margin-top: 10px;
      font-size: 0.92rem;
      font-weight: 900;
    }

    .step-footer{
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    @media (max-width: 1024px){
      .step-footer{
        position: sticky;
        bottom: 0;
        padding-top: 10px;
        padding-bottom: calc(8px + env(safe-area-inset-bottom));
        background: rgba(255,255,255,0.92);
        backdrop-filter: blur(8px);
        border-top: 1px dashed rgba(0,0,0,0.25);
        z-index: 5;
      }
      .btn-primary, .btn-secondary{
        flex: 1 1 0;
        min-width: 0;
      }
    }

    .btn-primary{
      background: #000;
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 900;
      font-size: 0.92rem;
      flex: 1;
      min-width: 160px;
    }
    .btn-secondary{
      background: #fff;
      color: #000;
      border: 2px solid #000;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 900;
      font-size: 0.92rem;
      flex: 0 0 auto;
    }
    .btn-primary:disabled{
      opacity: .55;
      cursor: not-allowed;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal {
      background: #fff;
      border-radius: 12px;
      padding: 18px;
      max-width: 920px;
      width: 92%;
      max-height: 85vh;
      overflow-y: auto;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 14px;
      font-size: 22px;
      cursor: pointer;
      background: none;
      border: none;
    }
    .modal h3 { margin-bottom: 12px; font-size: 1.1rem; }

    .report-text {
      background: #f3f4f6;
      padding: 14px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 0.78rem;
      white-space: pre-wrap;
      margin-top: 12px;
      border: 1px solid #000;
    }
    .copy-btn {
      background: #000;
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 10px;
      font-weight: 900;
    }

    .locked {
      opacity: 0.55;
      filter: grayscale(0.15);
      pointer-events: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="title-wrap">
        <img class="app-logo" src="logo-pulmones.png" alt="Logo pulmones">
        <h1>Interpretación de Espirometría (rápida)</h1>
      </div>
      <div class="header-buttons">
        <button class="icon-btn" onclick="openInfoModal()" title="Información">ℹ</button>
        <button class="icon-btn" onclick="clearAll()" title="Limpiar todo">L</button>
      </div>
    </header>

    <div class="desktop-grid">
      <div class="card" id="deskParams">
        <h2>Parámetros (PRE)</h2>

        <div class="input-row">
          <div class="input-group">
            <label>Mejor FVC (l)</label>
            <input type="text" id="mejorFVC" inputmode="decimal" placeholder="Ej: 4,85"
                   oninput="sanitizeDecimal(this); calcularTodo()">
          </div>
          <div class="input-group">
            <label>Mejor FEV1 (l)</label>
            <input type="text" id="mejorFEV1" inputmode="decimal" placeholder="Ej: 3,11"
                   oninput="sanitizeDecimal(this); calcularTodo()">
          </div>
        </div>

        <div class="input-group">
          <label>MFEV1/MFVC (%)</label>
          <input type="text" id="ratioMF" inputmode="decimal" placeholder="Del informe"
                 oninput="sanitizeDecimal(this); calcularTodo()">
          <div class="tiny">Si metes FEV1 y FVC, se autocalcula si este campo está vacío.</div>
        </div>

        <div class="input-row">
          <div class="input-group">
            <label>FVC %REF</label>
            <input type="text" id="fvcRef" inputmode="decimal" placeholder="Ej: 95"
                   oninput="sanitizeDecimal(this); calcularTodo()">
          </div>
          <div class="input-group">
            <label>FEV1 %REF</label>
            <input type="text" id="fev1Ref" inputmode="decimal" placeholder="Ej: 68"
                   oninput="sanitizeDecimal(this); calcularTodo()">
          </div>
        </div>

        <div class="input-group">
          <label>FEF25%-75% %REF (opcional)</label>
          <input type="text" id="fefRef" inputmode="decimal" placeholder="Ej: 81"
                 oninput="sanitizeDecimal(this); calcularTodo()">
        </div>

        <div class="field-error" id="fieldError"></div>

        <div class="hint">
          Para patrón rápido suele bastar con:
          <br>• <strong>RATIO</strong> (corte fijo 70)
          <br>• <strong>FVC %REF</strong> (80)
          <br>El <strong>grado</strong> (si hay obstrucción) usa <strong>FEV1 %REF</strong>.
        </div>
      </div>

      <div class="card" id="deskQuality">
        <h2>Calidad</h2>

        <div class="input-group">
          <label>Calidad suficiente (según tú / informe)</label>
          <select id="manualQuality" onchange="calcularTodo()">
            <option value="">— (usar ATS/ERS)</option>
            <option value="si">Sí (interpretable)</option>
            <option value="no">No (no interpretable)</option>
          </select>
          <div class="tiny">Si marcas Sí/No, ATS/ERS no hace falta. Si lo dejas en “—”, ATS/ERS debe estar completo.</div>
        </div>

        <div style="margin-top: 6px; padding-top: 6px; border-top: 1px dashed #000;">
          <div class="input-row">
            <div class="input-group">
              <label>Grado ATS/ERS: FVC</label>
              <select id="calidadFVC" onchange="calcularTodo()">
                <option value="">—</option>
                <option value="A">A</option><option value="B">B</option><option value="C">C</option>
                <option value="D">D</option><option value="E">E</option>
                <option value="F">F</option>
              </select>
            </div>
            <div class="input-group">
              <label>Grado ATS/ERS: FEV1</label>
              <select id="calidadFEV1" onchange="calcularTodo()">
                <option value="">—</option>
                <option value="A">A</option><option value="B">B</option><option value="C">C</option>
                <option value="D">D</option><option value="E">E</option>
                <option value="F">F</option>
              </select>
            </div>
          </div>

          <div class="input-row">
            <div class="input-group">
              <label>Reproducibilidad: FVC</label>
              <select id="repFVC" onchange="calcularTodo()">
                <option value="">—</option>
                <option value="si">Sí</option>
                <option value="no">No</option>
              </select>
            </div>
            <div class="input-group">
              <label>Reproducibilidad: FEV1</label>
              <select id="repFEV1" onchange="calcularTodo()">
                <option value="">—</option>
                <option value="si">Sí</option>
                <option value="no">No</option>
              </select>
            </div>
          </div>

          <div class="hint">
            Regla operativa:
            <br>• <strong>NO interpretable</strong> si calidad "F" o reproducibilidad "No" en FVC o FEV1.
            <br>• Si faltan datos → "pendiente" (la app NO interpreta).
          </div>
        </div>

        <div class="quality-warning" id="qualityWarning">
          <strong>NO INTERPRETABLE.</strong>
          <br>Evita decisiones basadas en esta prueba. Repetir asegurando calidad y reproducibilidad.
        </div>
      </div>

      <div class="card" id="deskInterp">
        <h2>Diagnóstico + Manejo</h2>

        <div class="result-display">
          <div class="result-item"><span>INTERPRETABLE</span><span class="result-value" id="outInterpretable">—</span></div>
          <div class="result-item"><span>Obstrucción (ratio &lt; 70)</span><span class="result-value" id="outObstruccion">—</span></div>
          <div class="result-item"><span>MFEV1/MFVC (%)</span><span class="result-value" id="outRatio">—</span></div>
          <div class="result-item"><span>FVC %REF</span><span class="result-value" id="outFvcRef">—</span></div>
          <div class="result-item"><span>FEV1 %REF</span><span class="result-value" id="outFev1Ref">—</span></div>
          <div class="result-item"><span>FEF25%-75% %REF (opc)</span><span class="result-value" id="outFefRef">—</span></div>
        </div>

        <div class="pattern-box" id="patron">PENDIENTE</div>
        <div class="severity" id="severidad"></div>
        <div class="grade-detail" id="gradoDetalle"></div>

        <div class="plan-section">
          <div class="plan-title">Manejo paso a paso (borrador)</div>
          <div class="plan-note">Se bloqueará si la prueba no es válida. La clínica manda.</div>

          <div class="input-row">
            <div class="input-group">
              <label>Sospecha clínica</label>
              <select id="sospecha" onchange="updatePlan()">
                <option value="no">No especificada</option>
                <option value="epoc">EPOC</option>
                <option value="asma">Asma</option>
                <option value="otros">Otros</option>
              </select>
            </div>
            <div class="input-group">
              <label>Contexto</label>
              <select id="contexto" onchange="updatePlan()">
                <option value="ap">Atención Primaria</option>
                <option value="seguimiento">Seguimiento</option>
                <option value="diagnostico">Duda diagnóstica</option>
              </select>
            </div>
          </div>

          <div class="plan-box" id="planBox">Introduce valores, añade calidad y calcula.</div>

          <div class="step-footer" style="margin-top: 10px;">
            <button class="btn-primary" onclick="generarInforme()">VER INFORME</button>
          </div>
        </div>
      </div>

      <div class="card" id="deskBD">
        <h2>Prueba Broncodilatadora</h2>

        <div class="hint" style="margin-bottom: 10px;">
          Criterios implementados:
          <br>• <strong>Clásico</strong>: ΔFEV1 ≥200 ml y ≥12% respecto a PRE.
          <br>• <strong>Alternativo</strong> (si hay FEV1 %REF): ΔFEV1 &gt;10% del FEV1 predicho (inferido).
        </div>

        <div class="input-group">
          <label>Mejor FEV1 (l) PRE</label>
          <input type="text" id="bdFev1Pre" inputmode="decimal" readonly>
        </div>

        <div class="input-group">
          <label>Mejor FEV1 (l) POST</label>
          <input type="text" id="bdFev1Post" inputmode="decimal" placeholder="Del informe post"
                 oninput="sanitizeDecimal(this); calcularBD()">
        </div>

        <div class="bd-result" id="bdresult">No calculada</div>

        <div class="hint" style="margin-top:10px;">
          <strong>Interpretación:</strong><br>
          • Positiva: sugiere variabilidad (compatible con asma)<br>
          • Negativa: NO excluye asma ni EPOC<br>
          • Siempre correlacionar con clínica
        </div>
      </div>
    </div>

    <div class="mobile-steps">
      <section class="screen active" id="screen1">
        <div class="card">
          <h2>Paso 1 · Calidad</h2>

          <div class="input-group">
            <label>Calidad suficiente (según tú / informe)</label>
            <select id="m_manualQuality" onchange="syncMobileToDesktop('manualQuality', this.value); calcularTodo();">
              <option value="">— (usar ATS/ERS)</option>
              <option value="si">Sí (interpretable)</option>
              <option value="no">No (no interpretable)</option>
            </select>
            <div class="tiny">Si marcas Sí/No, ATS/ERS no hace falta. Si lo dejas en “—”, completa ATS/ERS.</div>
          </div>

          <div style="margin-top: 6px; padding-top: 6px; border-top: 1px dashed #000;">
            <div class="input-row">
              <div class="input-group">
                <label>Grado ATS/ERS: FVC</label>
                <select id="m_calidadFVC" onchange="syncMobileToDesktop('calidadFVC', this.value); calcularTodo();">
                  <option value="">—</option>
                  <option value="A">A</option><option value="B">B</option><option value="C">C</option>
                  <option value="D">D</option><option value="E">E</option>
                  <option value="F">F</option>
                </select>
              </div>
              <div class="input-group">
                <label>Grado ATS/ERS: FEV1</label>
                <select id="m_calidadFEV1" onchange="syncMobileToDesktop('calidadFEV1', this.value); calcularTodo();">
                  <option value="">—</option>
                  <option value="A">A</option><option value="B">B</option><option value="C">C</option>
                  <option value="D">D</option><option value="E">E</option>
                  <option value="F">F</option>
                </select>
              </div>
            </div>

            <div class="input-row">
              <div class="input-group">
                <label>Reproducibilidad: FVC</label>
                <select id="m_repFVC" onchange="syncMobileToDesktop('repFVC', this.value); calcularTodo();">
                  <option value="">—</option>
                  <option value="si">Sí</option>
                  <option value="no">No</option>
                </select>
              </div>
              <div class="input-group">
                <label>Reproducibilidad: FEV1</label>
                <select id="m_repFEV1" onchange="syncMobileToDesktop('repFEV1', this.value); calcularTodo();">
                  <option value="">—</option>
                  <option value="si">Sí</option>
                  <option value="no">No</option>
                </select>
              </div>
            </div>

            <div class="hint">
              NO interpretable si calidad "F" o reproducibilidad "No" en FVC o FEV1.
              Si faltan datos → pendiente.
            </div>
          </div>

          <div class="quality-warning" id="m_qualityWarning">
            <strong>NO INTERPRETABLE.</strong>
            <br>Repetir asegurando calidad y reproducibilidad.
          </div>

          <div class="step-footer">
            <button class="btn-primary" id="btnContinue1" onclick="goNextFromQuality()">CONTINUAR</button>
          </div>
        </div>
      </section>

      <section class="screen" id="screen2">
        <div class="card">
          <h2>Paso 2 · Parámetros</h2>

          <div class="input-row">
            <div class="input-group">
              <label>Mejor FVC (l)</label>
              <input type="text" id="m_mejorFVC" inputmode="decimal" placeholder="Ej: 4,85"
                oninput="sanitizeDecimal(this); syncMobileToDesktop('mejorFVC', this.value); calcularTodo();">
            </div>
            <div class="input-group">
              <label>Mejor FEV1 (l)</label>
              <input type="text" id="m_mejorFEV1" inputmode="decimal" placeholder="Ej: 3,11"
                oninput="sanitizeDecimal(this); syncMobileToDesktop('mejorFEV1', this.value); calcularTodo();">
            </div>
          </div>

          <div class="input-group">
            <label>MFEV1/MFVC (%)</label>
            <input type="text" id="m_ratioMF" inputmode="decimal" placeholder="Del informe"
              oninput="sanitizeDecimal(this); syncMobileToDesktop('ratioMF', this.value); calcularTodo();">
            <div class="tiny">Si FEV1 y FVC están, se autocalcula si este campo está vacío.</div>
          </div>

          <div class="input-row">
            <div class="input-group">
              <label>FVC %REF</label>
              <input type="text" id="m_fvcRef" inputmode="decimal" placeholder="Ej: 95"
                oninput="sanitizeDecimal(this); syncMobileToDesktop('fvcRef', this.value); calcularTodo();">
            </div>
            <div class="input-group">
              <label>FEV1 %REF</label>
              <input type="text" id="m_fev1Ref" inputmode="decimal" placeholder="Ej: 68"
                oninput="sanitizeDecimal(this); syncMobileToDesktop('fev1Ref', this.value); calcularTodo();">
            </div>
          </div>

          <div class="input-group">
            <label>FEF25%-75% %REF (opcional)</label>
            <input type="text" id="m_fefRef" inputmode="decimal" placeholder="Ej: 81"
              oninput="sanitizeDecimal(this); syncMobileToDesktop('fefRef', this.value); calcularTodo();">
          </div>

          <div class="field-error" id="m_fieldError"></div>

          <div class="hint">
            Para cerrar patrón rápido:
            <br>• RATIO (corte 70)
            <br>• FVC %REF (80)
            <br>Grado por FEV1 %REF si obstrucción.
          </div>

          <div class="step-footer">
            <button class="btn-secondary" onclick="goStep(1)">ATRÁS</button>
            <button class="btn-primary" onclick="goNextFromParams()">INTERPRETAR</button>
          </div>
        </div>
      </section>

      <section class="screen" id="screen3">
        <div class="card">
          <h2>Paso 3 · Diagnóstico</h2>

          <div class="result-display">
            <div class="result-item"><span>INTERPRETABLE</span><span class="result-value" id="m_outInterpretable">—</span></div>
            <div class="result-item"><span>Obstrucción (ratio &lt; 70)</span><span class="result-value" id="m_outObstruccion">—</span></div>
            <div class="result-item"><span>MFEV1/MFVC (%)</span><span class="result-value" id="m_outRatio">—</span></div>
            <div class="result-item"><span>FVC %REF</span><span class="result-value" id="m_outFvcRef">—</span></div>
            <div class="result-item"><span>FEV1 %REF</span><span class="result-value" id="m_outFev1Ref">—</span></div>
          </div>

          <div class="pattern-box" id="m_patron">PENDIENTE</div>
          <div class="severity" id="m_severidad"></div>
          <div class="grade-detail" id="m_gradoDetalle"></div>

          <div class="step-footer">
            <button class="btn-secondary" onclick="goStep(2)">ATRÁS</button>
            <button class="btn-primary" onclick="goNextToBD()">PBD</button>
          </div>
        </div>
      </section>

      <section class="screen" id="screen4">
        <div class="card">
          <h2>Paso 4 · Prueba broncodilatadora</h2>

          <div class="hint">
            Criterios:
            <br>• Clásico: ΔFEV1 ≥200 ml y ≥12% vs PRE.
            <br>• Alternativo (si hay FEV1 %REF): ΔFEV1 &gt;10% del predicho.
          </div>

          <div class="input-group">
            <label>Mejor FEV1 (l) PRE</label>
            <input type="text" id="m_bdFev1Pre" inputmode="decimal" readonly>
          </div>

          <div class="input-group">
            <label>Mejor FEV1 (l) POST</label>
            <input type="text" id="m_bdFev1Post" inputmode="decimal" placeholder="Del informe post"
              oninput="sanitizeDecimal(this); syncMobileToDesktop('bdFev1Post', this.value); calcularBD();">
          </div>

          <div class="bd-result" id="m_bdresult">No calculada</div>

          <div class="step-footer">
            <button class="btn-secondary" onclick="goStep(3)">ATRÁS</button>
            <button class="btn-primary" onclick="goNextToPlan()">VER MANEJO</button>
          </div>
        </div>
      </section>

      <section class="screen" id="screen5">
        <div class="card">
          <h2>Paso 5 · Manejo</h2>

          <div class="input-row">
            <div class="input-group">
              <label>Sospecha clínica</label>
              <select id="m_sospecha" onchange="syncMobileToDesktop('sospecha', this.value); updatePlan();">
                <option value="no">No especificada</option>
                <option value="epoc">EPOC</option>
                <option value="asma">Asma</option>
                <option value="otros">Otros</option>
              </select>
            </div>
            <div class="input-group">
              <label>Contexto</label>
              <select id="m_contexto" onchange="syncMobileToDesktop('contexto', this.value); updatePlan();">
                <option value="ap">Atención Primaria</option>
                <option value="seguimiento">Seguimiento</option>
                <option value="diagnostico">Duda diagnóstica</option>
              </select>
            </div>
          </div>

          <div class="plan-section" style="margin-top: 0; padding-top: 0; border-top: none;">
            <div class="plan-title">Orientación y pasos</div>
            <div class="plan-note">Se bloquea si la prueba no es válida. Se refina con tu bibliografía.</div>
            <div class="plan-box" id="m_planBox">—</div>
          </div>

          <div class="step-footer">
            <button class="btn-secondary" onclick="goStep(4)">ATRÁS</button>
            <button class="btn-primary" onclick="goStep(6)">INFORME FINAL</button>
          </div>
        </div>
      </section>

      <section class="screen" id="screen6">
        <div class="card">
          <h2>Paso 6 · Informe final</h2>

          <div class="hint">Resumen autocopiable. Si NO interpretable, el informe se limita a “repetir”.</div>

          <pre class="report-text" id="m_reportContent"></pre>

          <div class="step-footer">
            <button class="btn-secondary" onclick="goStep(5)">ATRÁS</button>
            <button class="btn-primary" onclick="copiarInformeMovil()">COPIAR</button>
          </div>
        </div>
      </section>
    </div>

    <!-- ✅ Eliminado footer global (evita botón duplicado y conflictos en móvil). -->
    <div style="text-align:right; font-size:.72rem; font-weight:600; color:#000; padding: 0 6px; flex-shrink:0;">
      Hecho por Guillermo J. Olivero Sanjuanelo
    </div>
  </div>

  <div class="modal-overlay" id="reportModal">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('reportModal')">X</button>
      <h3>Informe (resumen)</h3>
      <pre class="report-text" id="reportContent"></pre>
      <button class="copy-btn" onclick="copiarInforme()">Copiar</button>
    </div>
  </div>

  <div class="modal-overlay" id="infoModal">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('infoModal')">X</button>
      <h3>Información útil</h3>
      <div class="hint">
        Pendiente de ampliar: contenido clínico completo del botón ℹ + tratamiento/seguimiento detallado en “Manejo”.
      </div>
    </div>
  </div>

  <script>
    let current = {
      fecha: new Date().toLocaleDateString('es-ES'),
      patron: null,
      severidad: null,
      severidadClass: '',
      obstruccion: null,
      interpretable: null,
      bd: null
    };
    let hasEverCalculated = false;

    // Permite coma decimal: el usuario puede escribir "3,11" y se interpreta como 3.11
    function sanitizeDecimal(inputEl){
      if (!inputEl) return;
      let v = (inputEl.value || '');
      // mantener solo dígitos, coma, punto y signo menos (por si pega algo raro)
      v = v.replace(/[^\d,.\-]/g, '');
      // Si hay más de un separador, dejamos el primero y quitamos los demás
      const firstComma = v.indexOf(',');
      const firstDot = v.indexOf('.');
      if (firstComma !== -1 && firstDot !== -1){
        // si hay ambos, dejamos el primero que aparezca y quitamos el otro
        if (firstComma < firstDot) v = v.replace(/\./g, '');
        else v = v.replace(/,/g, '');
      }
      inputEl.value = v;
    }

    function num(id){
      const el = document.getElementById(id);
      if (!el) return null;
      const raw = (el.value || '').trim().replace(',', '.');
      if (raw === '' || raw === '-' || raw === '.' || raw === '-.') return null;
      const v = parseFloat(raw);
      return isNaN(v) ? null : v;
    }
    function txt(id){
      const el = document.getElementById(id);
      return el ? (el.value || '').trim() : '';
    }

    function inRange(v, min, max){ return v !== null && v >= min && v <= max; }

    function setFieldError(msg){
      const box = document.getElementById('fieldError');
      const mbox = document.getElementById('m_fieldError');
      if (box){
        if (!msg){ box.textContent=''; box.classList.remove('show'); }
        else { box.textContent = msg; box.classList.add('show'); }
      }
      if (mbox){
        if (!msg){ mbox.textContent=''; mbox.classList.remove('show'); }
        else { mbox.textContent = msg; mbox.classList.add('show'); }
      }
    }

    function validateHumanLimits(){
      const fvc = num('mejorFVC');
      const fev1 = num('mejorFEV1');
      const ratio = num('ratioMF');
      const fvcRef = num('fvcRef');
      const fev1Ref = num('fev1Ref');
      const fefRef = num('fefRef');
      const post = num('bdFev1Post');

      if (fvc !== null && !inRange(fvc, 0.20, 8.00)) return 'Mejor FVC fuera de rango (0.20–8.00 L).';
      if (fev1 !== null && !inRange(fev1, 0.20, 8.00)) return 'Mejor FEV1 fuera de rango (0.20–8.00 L).';
      if (ratio !== null && !inRange(ratio, 5, 110)) return 'MFEV1/MFVC fuera de rango (5–110%).';
      if (fvcRef !== null && !inRange(fvcRef, 10, 250)) return 'FVC %REF fuera de rango (10–250%).';
      if (fev1Ref !== null && !inRange(fev1Ref, 10, 250)) return 'FEV1 %REF fuera de rango (10–250%).';
      if (fefRef !== null && !inRange(fefRef, 10, 250)) return 'FEF25–75 %REF fuera de rango (10–250%).';
      if (post !== null && !inRange(post, 0.20, 8.00)) return 'PBD POST (FEV1) fuera de rango (0.20–8.00 L).';
      return null;
    }

    function autoFillRatioIfEmpty(){
      const fvc = num('mejorFVC');
      const fev1 = num('mejorFEV1');
      const ratioInput = document.getElementById('ratioMF');
      const mRatioInput = document.getElementById('m_ratioMF');

      const raw = ratioInput ? (ratioInput.value || '').trim() : '';
      if (raw !== '') return;
      if (fvc && fev1 && fvc > 0) {
        const v = ((fev1 / fvc) * 100).toFixed(2);
        if (ratioInput) ratioInput.value = v;
        if (mRatioInput && (mRatioInput.value || '').trim() === '') mRatioInput.value = v;
      }
    }

    function isGradeAcceptable(g){
      if (!g) return null;
      if (g === 'F') return false;
      return true;
    }
    function isRepOK(r){
      if (!r) return null;
      return r === 'si';
    }

    function computeInterpretability(){
      const manual = txt('manualQuality');
      if (manual === 'si') return true;
      if (manual === 'no') return false;

      const qFVC = isGradeAcceptable(txt('calidadFVC'));
      const qFEV1 = isGradeAcceptable(txt('calidadFEV1'));
      const rFVC = isRepOK(txt('repFVC'));
      const rFEV1 = isRepOK(txt('repFEV1'));

      if (qFVC === null || qFEV1 === null || rFVC === null || rFEV1 === null) return null;
      return (qFVC && qFEV1 && rFVC && rFEV1);
    }

    function getObstructionGradeFromRef(fev1Ref){
      if (fev1Ref === null || fev1Ref === undefined || isNaN(fev1Ref)) return null;
      if (fev1Ref >= 80) return { label: 'Leve', cls: 'leve' };
      if (fev1Ref >= 50) return { label: 'Moderada', cls: 'moderado' };
      if (fev1Ref >= 30) return { label: 'Grave', cls: 'severo' };
      return { label: 'Muy grave', cls: 'muy-severo' };
    }

    function renderGradeDetail(targetId, data){
      const box = document.getElementById(targetId);
      if (!box) return;
      if (!data || !data.show) {
        box.classList.remove('show');
        box.textContent = '';
        return;
      }
      const chip = `<span class="grade-chip">${data.chip}</span>`;
      box.innerHTML =
        `<span class="k">Detalle</span>${chip}\n` +
        `${data.mainLine}\n` +
        `${data.subLine ? data.subLine + '\n' : ''}` +
        `${data.note ? data.note : ''}`;
      box.classList.add('show');
    }

    function updateOutputs(){
      const outInter = document.getElementById('outInterpretable');
      const outObs = document.getElementById('outObstruccion');
      if (outInter) outInter.textContent = (current.interpretable === null) ? '—' : (current.interpretable ? 'SÍ' : 'NO');
      if (outObs) outObs.textContent = (current.obstruccion === null) ? '—' : (current.obstruccion ? 'SÍ' : 'NO');

      const r = num('ratioMF');
      const fvcRef = num('fvcRef');
      const fev1Ref = num('fev1Ref');
      const fefRef = num('fefRef');

      const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
      set('outRatio', (r===null) ? '—' : (r.toFixed(2) + '%'));
      set('outFvcRef', (fvcRef===null) ? '—' : (fvcRef.toFixed(1) + '%'));
      set('outFev1Ref', (fev1Ref===null) ? '—' : (fev1Ref.toFixed(1) + '%'));
      set('outFefRef', (fefRef===null) ? '—' : (fefRef.toFixed(1) + '%'));

      const mSet = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
      mSet('m_outInterpretable', (current.interpretable === null) ? '—' : (current.interpretable ? 'SÍ' : 'NO'));
      mSet('m_outObstruccion', (current.obstruccion === null) ? '—' : (current.obstruccion ? 'SÍ' : 'NO'));
      mSet('m_outRatio', (r===null) ? '—' : (r.toFixed(2) + '%'));
      mSet('m_outFvcRef', (fvcRef===null) ? '—' : (fvcRef.toFixed(1) + '%'));
      mSet('m_outFev1Ref', (fev1Ref===null) ? '—' : (fev1Ref.toFixed(1) + '%'));

      const pre = num('mejorFEV1');
      const bdPre = document.getElementById('bdFev1Pre');
      const mBdPre = document.getElementById('m_bdFev1Pre');
      if (bdPre) bdPre.value = (pre===null) ? '' : pre.toFixed(2);
      if (mBdPre) mBdPre.value = (pre===null) ? '' : pre.toFixed(2);

      const bdPost = document.getElementById('bdFev1Post');
      const mBdPost = document.getElementById('m_bdFev1Post');
      if (bdPost && mBdPost && (mBdPost.value || '').trim() === '' && (bdPost.value || '').trim() !== '') {
        mBdPost.value = bdPost.value;
      }
    }

    function showResult(){
      const patronDiv = document.getElementById('patron');
      const sevDiv = document.getElementById('severidad');
      const mPatronDiv = document.getElementById('m_patron');
      const mSevDiv = document.getElementById('m_severidad');

      const p = current.patron || 'PENDIENTE';
      if (patronDiv){
        patronDiv.textContent = p;
        patronDiv.classList.toggle('no-interpretable', p === 'NO INTERPRETABLE');
      }
      if (mPatronDiv){
        mPatronDiv.textContent = p;
        mPatronDiv.classList.toggle('no-interpretable', p === 'NO INTERPRETABLE');
      }

      const s = current.severidad || '';
      if (sevDiv){
        sevDiv.textContent = s;
        sevDiv.className = 'severity ' + (current.severidadClass || '');
      }
      if (mSevDiv){
        mSevDiv.textContent = s;
        mSevDiv.className = 'severity ' + (current.severidadClass || '');
      }

      updateOutputs();
      syncLocking();
    }

    function calcularPatronYGrado(){
      const limitsError = validateHumanLimits();
      if (limitsError) {
        setFieldError(limitsError);
        current.interpretable = null;
        current.obstruccion = null;
        current.patron = 'PENDIENTE (revisar valores)';
        current.severidad = '';
        current.severidadClass = '';
        renderGradeDetail('gradoDetalle', {
          show:true, chip:'Valores',
          mainLine:'• Corrige el valor fuera de rango.',
          subLine:limitsError, note:''
        });
        renderGradeDetail('m_gradoDetalle', {
          show:true, chip:'Valores',
          mainLine:'• Corrige el valor fuera de rango.',
          subLine:limitsError, note:''
        });
        showResult();
        updatePlan();
        return;
      }
      setFieldError(null);

      current.interpretable = computeInterpretability();

      const warn = document.getElementById('qualityWarning');
      const mWarn = document.getElementById('m_qualityWarning');
      if (current.interpretable === false && hasEverCalculated) {
        if (warn) warn.classList.add('show');
        if (mWarn) mWarn.classList.add('show');
      } else {
        if (warn) warn.classList.remove('show');
        if (mWarn) mWarn.classList.remove('show');
      }

      if (current.interpretable === null) {
        current.patron = 'PENDIENTE (calidad no confirmada)';
        current.severidad = '';
        current.severidadClass = '';
        current.obstruccion = null;
        renderGradeDetail('gradoDetalle', {
          show:true, chip:'Calidad',
          mainLine:'• No se interpreta hasta confirmar calidad.',
          subLine:'• Marca "Calidad suficiente: Sí/No" o completa ATS/ERS (FVC+FEV1 + reproducibilidad).',
          note:''
        });
        renderGradeDetail('m_gradoDetalle', {
          show:true, chip:'Calidad',
          mainLine:'• No se interpreta hasta confirmar calidad.',
          subLine:'• Marca "Calidad suficiente: Sí/No" o completa ATS/ERS (FVC+FEV1 + reproducibilidad).',
          note:''
        });
        showResult();
        updatePlan();
        return;
      }

      if (current.interpretable === false) {
        current.patron = 'NO INTERPRETABLE';
        current.severidad = 'Repetir (calidad/reproducibilidad insuficiente)';
        current.severidadClass = '';
        current.obstruccion = null;
        renderGradeDetail('gradoDetalle', { show:false });
        renderGradeDetail('m_gradoDetalle', { show:false });
        showResult();
        updatePlan();
        return;
      }

      const ratio = num('ratioMF');
      const fvcRef = num('fvcRef');
      const fev1Ref = num('fev1Ref');

      if (ratio === null) {
        current.obstruccion = null;
        current.patron = 'PENDIENTE (falta RATIO)';
        current.severidad = '';
        current.severidadClass = '';
        renderGradeDetail('gradoDetalle', {
          show:true, chip:'Faltan datos',
          mainLine:'• Para decidir obstrucción: introduce MFEV1/MFVC (%).',
          subLine:'', note:''
        });
        renderGradeDetail('m_gradoDetalle', {
          show:true, chip:'Faltan datos',
          mainLine:'• Para decidir obstrucción: introduce MFEV1/MFVC (%).',
          subLine:'', note:''
        });
        showResult();
        updatePlan();
        return;
      }

      current.obstruccion = (ratio < 70);

      const hasFvcRef = (fvcRef !== null);
      let patron = 'PENDIENTE';
      let sev = '';
      let sevClass = '';
      let detail = { show:false };

      if (current.obstruccion) {
        if (hasFvcRef) {
          patron = (fvcRef <= 80)
            ? 'OBSTRUCTIVO con FVC baja (atrapamiento vs mixto)'
            : 'OBSTRUCTIVO';
        } else {
          patron = 'OBSTRUCTIVO (falta FVC %REF para matizar)';
        }

        const g = getObstructionGradeFromRef(fev1Ref);
        if (g) {
          sev = `${g.label} (FEV1 ${fev1Ref.toFixed(1)}%REF)`;
          sevClass = g.cls;
          detail = {
            show:true, chip:'Obstrucción · grado',
            mainLine:`• Obstrucción: ratio ${ratio.toFixed(2)}% < 70%.`,
            subLine:`• Grado por FEV1 %REF = ${fev1Ref.toFixed(1)}% → ${g.label.toUpperCase()}.`,
            note:(fvcRef !== null && fvcRef <= 80)
              ? '• FVC baja: puede ser atrapamiento (pseudorrestricción) o patrón mixto real; si cambia conducta, confirmar con volúmenes (TLC).'
              : ''
          };
        } else {
          sev = 'Sin grado (falta FEV1 %REF)';
          detail = {
            show:true, chip:'Obstrucción',
            mainLine:`• Obstrucción: ratio ${ratio.toFixed(2)}% < 70%.`,
            subLine:`• Para grado, añade FEV1 %REF.`,
            note:''
          };
        }
      } else {
        if (!hasFvcRef) {
          patron = 'NO OBSTRUCCIÓN (falta FVC %REF para normal vs restricción sugerida)';
          detail = {
            show:true, chip:'Faltan datos',
            mainLine:`• NO obstrucción: ratio ${ratio.toFixed(2)}% ≥ 70%.`,
            subLine:`• Para cerrar patrón, añade FVC %REF.`,
            note:''
          };
        } else {
          if (fvcRef <= 80) {
            patron = 'RESTRICTIVO (sugerido)';
            sev = 'Confirmar con volúmenes/TLC si procede';
            detail = {
              show:true, chip:'Restricción sugerida',
              mainLine:`• NO obstrucción: ratio ${ratio.toFixed(2)}% ≥ 70%.`,
              subLine:`• FVC %REF ${fvcRef.toFixed(1)}% ≤80 → restricción sugerida.`,
              note:''
            };
          } else {
            patron = 'NORMAL';
            sev = 'Sin alteraciones (según cortes)';
            sevClass = 'normal';
            detail = {
              show:true, chip:'Normal',
              mainLine:`• NO obstrucción: ratio ${ratio.toFixed(2)}% ≥ 70%.`,
              subLine:`• FVC %REF ${fvcRef.toFixed(1)}% >80 → normal.`,
              note:`• Si hay síntomas, correlacionar (asma intercrisis puede ser normal).`
            };
          }
        }
      }

      current.patron = patron;
      current.severidad = sev;
      current.severidadClass = sevClass;
      renderGradeDetail('gradoDetalle', detail);
      renderGradeDetail('m_gradoDetalle', detail);

      showResult();
      updatePlan();
    }

    function buildGeneralPlan(){
      if (!hasEverCalculated) return 'Introduce valores, añade calidad y calcula.';

      if (current.interpretable === null) {
        return `CALIDAD: PENDIENTE

La app NO interpreta ni propone manejo hasta confirmar calidad.
Siguiente paso:
- Marca "Calidad suficiente: Sí/No" o completa ATS/ERS (FVC+FEV1 + reproducibilidad).`;
      }

      if (current.interpretable === false) {
        return `DX FUNCIONAL: NO INTERPRETABLE

No tomar decisiones basadas en esta prueba.
Siguiente paso:
- Repetir espirometría asegurando calidad y reproducibilidad.`;
      }

      const patron = current.patron || '—';
      const sospecha = txt('sospecha');
      const contexto = txt('contexto');
      const ratio = num('ratioMF');
      const fvcRef = num('fvcRef');
      const fev1Ref = num('fev1Ref');

      const lines = [];
      lines.push(`DX FUNCIONAL: ${patron}`);
      if (current.severidad) lines.push(`Grado/nota: ${current.severidad}`);
      lines.push(getBDLine());
      lines.push('');
      lines.push('PASOS (borrador, a completar con tu bibliografía):');

      if (patron.includes('OBSTRUCTIVO')) {
        lines.push('1) Confirmar calidad y revisar coherencia con clínica/exposición.');
        lines.push('2) Integrar PBD con clínica: asma vs EPOC vs solapamiento.');
        lines.push('3) Si FVC baja: atrapamiento vs restricción; si cambia conducta, considerar volúmenes (TLC).');
      } else if (patron.includes('RESTRICTIVO')) {
        lines.push('1) Confirmar calidad.');
        lines.push('2) Si cambia conducta: confirmar con volúmenes/TLC (según disponibilidad).');
        lines.push('3) Integrar causas probables según clínica (obesidad/pared torácica/intersticial…).');
      } else if (patron.includes('NORMAL')) {
        lines.push('1) Normal no excluye asma intercrisis si clínica lo sugiere.');
        lines.push('2) Repetir en fase sintomática si sospecha alta.');
        lines.push('3) Considerar otras causas de disnea (IC, anemia, descondicionamiento…).');
      } else {
        lines.push('1) Completar datos clave (RATIO y/o FVC %REF) para cerrar patrón.');
      }

      lines.push('');
      lines.push('Datos clave:');
      if (ratio !== null) lines.push(`- RATIO = ${ratio.toFixed(2)}% (corte 70)`);
      if (fvcRef !== null) lines.push(`- FVC %REF = ${fvcRef.toFixed(1)}%`);
      if (fev1Ref !== null) lines.push(`- FEV1 %REF = ${fev1Ref.toFixed(1)}%`);

      if (sospecha !== 'no') {
        lines.push('');
        lines.push(`Sospecha: ${sospecha.toUpperCase()}`);
        lines.push('• Tratamiento/seguimiento: pendiente de completar con tu bibliografía.');
      }

      lines.push('');
      lines.push(`Contexto: ${contexto === 'ap' ? 'Atención Primaria' : (contexto === 'seguimiento' ? 'Seguimiento' : 'Duda diagnóstica')}`);

      return lines.join('\n');
    }

    function updatePlan(){
      const text = buildGeneralPlan();
      const plan = document.getElementById('planBox');
      const mPlan = document.getElementById('m_planBox');
      if (plan) plan.textContent = text;
      if (mPlan) mPlan.textContent = text;
      buildMobileFinalReport();
    }

    function calcularTodo(){
      hasEverCalculated = true;
      autoFillRatioIfEmpty();
      current.fecha = new Date().toLocaleDateString('es-ES');
      calcularPatronYGrado();
      updatePlan();
      buildMobileFinalReport();
      syncDesktopToMobile();
    }

    function calcularBD(){
      const pre = num('bdFev1Pre');
      const post = num('bdFev1Post');

      const bd = document.getElementById('bdresult');
      const mbd = document.getElementById('m_bdresult');

      const setRes = (txt, ok, color) => {
        if (bd){ bd.textContent = txt; bd.style.background = color || '#000'; }
        if (mbd){ mbd.textContent = txt; mbd.style.background = color || '#000'; }
      };

      if (!pre || !post) {
        setRes('No calculada', false, '#000');
        current.bd = null;
        updatePlan();
        syncDesktopToMobile();
        return;
      }

      if (!inRange(post, 0.20, 8.00)) {
        setRes('POST fuera de rango', false, '#DC2626');
        current.bd = null;
        updatePlan();
        syncDesktopToMobile();
        return;
      }

      const cambioAbs = post - pre;
      const cambioPor = (cambioAbs / pre) * 100;

      const classicPos = (cambioAbs >= 0.2) && (cambioPor >= 12);

      const fev1Ref = num('fev1Ref');
      let pred = null;
      let altPos = null;
      let cambioPredPor = null;

      if (fev1Ref !== null && fev1Ref > 0) {
        pred = pre / (fev1Ref / 100);
        cambioPredPor = (cambioAbs / pred) * 100;
        altPos = (cambioPredPor > 10);
      }

      const esPositiva = classicPos || (altPos === true);

      const absMl = Math.round(cambioAbs * 1000);
      const signo = (cambioPor >= 0) ? '+' : '';
      let extra = '';

      if (pred !== null && cambioPredPor !== null) {
        const signo2 = (cambioPredPor >= 0) ? '+' : '';
        extra = ` | Δ%pred=${signo2}${cambioPredPor.toFixed(1)}%`;
      } else {
        extra = ' | Δ%pred=—';
      }

      const res = esPositiva
        ? `POSITIVA (${signo}${cambioPor.toFixed(1)}%, ${absMl} ml)${extra}`
        : `NEGATIVA (${signo}${cambioPor.toFixed(1)}%, ${absMl} ml)${extra}`;

      setRes(res, esPositiva, esPositiva ? '#059669' : '#DC2626');
      current.bd = { pre, post, cambioAbs, cambioPor, classicPos, altPos, pred, cambioPredPor, esPositiva, absMl, texto: res };

      updatePlan();
      buildMobileFinalReport();
      syncDesktopToMobile();
    }

    function getBDLine(){
      if (!current.bd) return 'PBD: no realizada o no calculada.';
      return `PBD: ${current.bd.texto}  |  PRE=${current.bd.pre.toFixed(2)} L  POST=${current.bd.post.toFixed(2)} L`;
    }

    function isMobileView(){
      return window.matchMedia && window.matchMedia('(max-width: 1024px)').matches;
    }

    // ✅ Informe: se genera al final (móvil) y en desktop solo con el botón "VER INFORME" (una sola entrada).
    function generarInforme(){
      if (!hasEverCalculated) {
        alert('Primero introduce valores y calcula.');
        return;
      }

      const lines = buildFullReportLines();
      const text = lines.join('\n');

      if (isMobileView()) {
        const box = document.getElementById('m_reportContent');
        if (box) box.textContent = text;
        goStep(6);
        return;
      }

      document.getElementById('reportContent').textContent = text;
      document.getElementById('reportModal').style.display = 'flex';
    }

    function buildFullReportLines(){
      const lines = [];
      lines.push('INFORME DE ESPIROMETRÍA (resumen)');
      lines.push(`Fecha: ${current.fecha}`);
      lines.push('');

      lines.push('DATOS INTRODUCIDOS (PRE):');
      lines.push(`- Mejor FVC (l): ${num('mejorFVC') === null ? '—' : num('mejorFVC').toFixed(2)}`);
      lines.push(`- Mejor FEV1 (l): ${num('mejorFEV1') === null ? '—' : num('mejorFEV1').toFixed(2)}`);
      lines.push(`- MFEV1/MFVC (%): ${num('ratioMF') === null ? '—' : num('ratioMF').toFixed(2)}`);
      lines.push(`- FVC %REF: ${num('fvcRef') === null ? '—' : num('fvcRef').toFixed(1)}`);
      lines.push(`- FEV1 %REF: ${num('fev1Ref') === null ? '—' : num('fev1Ref').toFixed(1)}`);
      lines.push(`- FEF25%-75% %REF (opcional): ${num('fefRef') === null ? '—' : num('fefRef').toFixed(1)}`);
      lines.push('');

      lines.push('CALIDAD:');
      lines.push(`- Calidad suficiente (manual): ${txt('manualQuality') ? (txt('manualQuality')==='si'?'Sí':'No') : '—'}`);
      lines.push(`- ATS/ERS (si usado): FVC ${txt('calidadFVC') || '—'} / FEV1 ${txt('calidadFEV1') || '—'} | Rep FVC ${txt('repFVC')||'—'} / Rep FEV1 ${txt('repFEV1')||'—'}`);
      lines.push('');

      const bdPre = num('bdFev1Pre');
      const bdPost = num('bdFev1Post');
      lines.push('PBD (si procede):');
      lines.push(`- Mejor FEV1 (l) PRE: ${bdPre === null ? '—' : bdPre.toFixed(2)}`);
      lines.push(`- Mejor FEV1 (l) POST: ${bdPost === null ? '—' : bdPost.toFixed(2)}`);
      lines.push('');

      lines.push('RESULTADOS:');
      lines.push(`- INTERPRETABLE: ${current.interpretable === null ? '— (pendiente)' : (current.interpretable ? 'SÍ' : 'NO')}`);
      lines.push(`- Obstrucción (ratio <70): ${current.obstruccion === null ? '—' : (current.obstruccion ? 'SÍ' : 'NO')}`);
      lines.push(`- Patrón: ${current.patron || '—'}`);
      lines.push(`- Grado/nota: ${current.severidad || '—'}`);
      lines.push(`- ${getBDLine()}`);
      lines.push('');
      lines.push('MANEJO / PRÓXIMOS PASOS:');
      lines.push(buildGeneralPlan());
      return lines;
    }

    function copiarInforme(){
      const texto = document.getElementById('reportContent').textContent;
      navigator.clipboard.writeText(texto).then(() => alert('Informe copiado'));
    }

    function buildMobileFinalReport(){
      const box = document.getElementById('m_reportContent');
      if (!box) return;
      if (!hasEverCalculated) { box.textContent = ''; return; }
      const lines = buildFullReportLines();
      box.textContent = lines.join('\n');
    }

    function copiarInformeMovil(){
      const texto = document.getElementById('m_reportContent').textContent;
      if (!texto) { alert('No hay informe aún.'); return; }
      navigator.clipboard.writeText(texto).then(() => alert('Informe copiado'));
    }

    function openInfoModal(){
      document.getElementById('infoModal').style.display = 'flex';
    }
    function closeModal(id){ document.getElementById(id).style.display = 'none'; }

    window.onclick = function(event){
      if (event.target.classList.contains('modal-overlay')) event.target.style.display = 'none';
    };

    function clearAll(){
      [
        'mejorFVC','mejorFEV1','ratioMF','fvcRef','fev1Ref','fefRef','bdFev1Post'
      ].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });

      ['manualQuality','calidadFVC','calidadFEV1','repFVC','repFEV1','sospecha','contexto'].forEach(id=>{
        const el = document.getElementById(id);
        if (!el) return;
        if (id==='sospecha') el.value = 'no';
        else if (id==='contexto') el.value = 'ap';
        else el.value = '';
      });

      [
        'm_mejorFVC','m_mejorFEV1','m_ratioMF','m_fvcRef','m_fev1Ref','m_fefRef','m_bdFev1Post'
      ].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });

      ['m_manualQuality','m_calidadFVC','m_calidadFEV1','m_repFVC','m_repFEV1','m_sospecha','m_contexto'].forEach(id=>{
        const el = document.getElementById(id);
        if (!el) return;
        if (id==='m_sospecha') el.value = 'no';
        else if (id==='m_contexto') el.value = 'ap';
        else el.value = '';
      });

      setFieldError(null);

      const warn = document.getElementById('qualityWarning');
      const mWarn = document.getElementById('m_qualityWarning');
      if (warn) warn.classList.remove('show');
      if (mWarn) mWarn.classList.remove('show');

      const bd = document.getElementById('bdresult');
      const mbd = document.getElementById('m_bdresult');
      if (bd){ bd.textContent = 'No calculada'; bd.style.background = '#000'; }
      if (mbd){ mbd.textContent = 'No calculada'; mbd.style.background = '#000'; }

      current = {
        fecha: new Date().toLocaleDateString('es-ES'),
        patron: null, severidad: null, severidadClass: '',
        obstruccion: null, interpretable: null, bd: null
      };
      hasEverCalculated = false;

      renderGradeDetail('gradoDetalle', {show:false});
      renderGradeDetail('m_gradoDetalle', {show:false});

      const p = document.getElementById('patron');
      const mp = document.getElementById('m_patron');
      if (p){ p.textContent = 'PENDIENTE'; p.classList.remove('no-interpretable'); }
      if (mp){ mp.textContent = 'PENDIENTE'; mp.classList.remove('no-interpretable'); }

      const s = document.getElementById('severidad');
      const ms = document.getElementById('m_severidad');
      if (s){ s.textContent = ''; s.className = 'severity'; }
      if (ms){ ms.textContent = ''; ms.className = 'severity'; }

      updatePlan();
      updateOutputs();
      goStep(1);
      syncLocking();
      syncDesktopToMobile();
    }

    function syncLocking(){
      const lock = (current.interpretable === false || current.interpretable === null);

      const deskInterp = document.getElementById('deskInterp');
      const deskBD = document.getElementById('deskBD');
      if (deskInterp) deskInterp.classList.toggle('locked', lock);
      if (deskBD) deskBD.classList.toggle('locked', lock);

      const mWarn = document.getElementById('m_qualityWarning');
      if (mWarn){
        if (current.interpretable === false && hasEverCalculated) mWarn.classList.add('show');
        else mWarn.classList.remove('show');
      }
    }

    function goStep(n){
      const screens = {
        1: 'screen1',
        2: 'screen2',
        3: 'screen3',
        4: 'screen4', // PBD
        5: 'screen5', // Manejo
        6: 'screen6'  // Informe final
      };

      Object.values(screens).forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.classList.remove('active');
      });

      const id = screens[n];
      if (id) document.getElementById(id).classList.add('active');
      if (n === 6) buildMobileFinalReport();
    }

    function goNextFromQuality(){
      hasEverCalculated = true;
      calcularTodo();

      if (current.interpretable === null) {
        alert('Calidad pendiente. Marca "Calidad suficiente: Sí/No" o completa ATS/ERS + reproducibilidad.');
        goStep(1);
        return;
      }
      if (current.interpretable === false) {
        alert('NO interpretable. No se puede continuar: repetir espirometría con calidad/reproducibilidad.');
        goStep(1);
        return;
      }
      goStep(2);
    }

    function goNextFromParams(){
      hasEverCalculated = true;
      calcularTodo();

      if (current.interpretable !== true) {
        alert('Primero confirma calidad (interpretable).');
        goStep(1);
        return;
      }
      if (num('ratioMF') === null) {
        alert('Falta el RATIO (MFEV1/MFVC %). No se puede interpretar sin él.');
        goStep(2);
        return;
      }
      goStep(3);
    }

    function goNextToBD(){
      hasEverCalculated = true;
      calcularTodo();

      if (current.interpretable !== true) {
        alert('No interpretable o pendiente. No se puede continuar.');
        goStep(1);
        return;
      }
      if (num('ratioMF') === null) {
        alert('Falta el RATIO (MFEV1/MFVC %).');
        goStep(2);
        return;
      }
      goStep(4);
    }

    function goNextToPlan(){
      hasEverCalculated = true;
      calcularTodo();

      if (current.interpretable !== true) {
        alert('No interpretable o pendiente. No se puede acceder a manejo.');
        goStep(1);
        return;
      }
      goStep(5);
    }

    function syncMobileToDesktop(id, value){
      const desk = document.getElementById(id);
      if (desk) desk.value = value;
      if (id === 'sospecha' || id === 'contexto') updatePlan();
      syncDesktopToMobile();
    }

    function syncDesktopToMobile(){
      const map = [
        ['manualQuality','m_manualQuality'],
        ['calidadFVC','m_calidadFVC'],
        ['calidadFEV1','m_calidadFEV1'],
        ['repFVC','m_repFVC'],
        ['repFEV1','m_repFEV1'],
        ['mejorFVC','m_mejorFVC'],
        ['mejorFEV1','m_mejorFEV1'],
        ['ratioMF','m_ratioMF'],
        ['fvcRef','m_fvcRef'],
        ['fev1Ref','m_fev1Ref'],
        ['fefRef','m_fefRef'],
        ['bdFev1Post','m_bdFev1Post'],
        ['sospecha','m_sospecha'],
        ['contexto','m_contexto'],
      ];
      map.forEach(([d,m])=>{
        const de = document.getElementById(d);
        const me = document.getElementById(m);
        if (de && me) me.value = de.value;
      });
    }

    window.onload = function(){
      updateOutputs();
      updatePlan();
      syncDesktopToMobile();
      syncLocking();
      goStep(1);
    };
  </script>
</body>
</html>
